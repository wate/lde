# code: language=ansible
---
- name: Wikiページの更新
  hosts: all
  become: false
  connection: local
  vars:
    redmine_api_key: "{{ lookup('env', 'REDMINE_API_KEY') }}"
    redmine_url: "{{ lookup('env', 'REDMINE_URL') }}"
    redmine_project: "{{ lookup('env', 'REDMINE_PROJECT') }}"
    wiki_pages:
      - name: Wiki
        file: docs/index.md
      - name: 機能一覧
        file: docs/features.md
        parent: Wiki
      - name: データ構造
        file: docs/er_diagram.md
        parent: Wiki
        attachments:
          - docs/er_diagram.drawio.png
      - name: システム構成
        parent: Wiki
        file: docs/architecture.md
        attachments:
          - docs/architecture.drawio.png
      - name: デプロイ方法
        parent: Wiki
        file: docs/deploy.md
  pre_tasks:
    - name: 環境変数の検証
      ansible.builtin.assert:
        that:
          - lookup('env', 'REDMINE_API_KEY') | length > 0
          - lookup('env', 'REDMINE_URL') | length > 0
          - lookup('env', 'REDMINE_PROJECT') | length > 0
        fail_msg: 更新先Redmineを指定する環境変数が設定されていません
  tasks:
    - name: Wikiページの更新
      ansible.builtin.include_tasks:
        file: update_page.yml
      loop: "{{ wiki_pages }}"
      loop_control:
        label: "{{ page.name }}"
        loop_var: page
