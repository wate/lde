# code: language=ansible
---
- name: Wikiページの更新
  hosts: all
  become: false
  gather_facts: false
  connection: local
  pre_tasks:
    - name: Redmine情報の検証
      ansible.builtin.assert:
        that:
          - redmine_api_key | length > 0
          - redmine_url | length > 0
          - redmine_project | length > 0
        fail_msg: 更新対象のRedmine情報が設定されていません
  tasks:
    - name: 登録済みのWikiページ一覧を取得
      ansible.builtin.uri:
        method: GET
        url: "{{ redmine_url }}/projects/{{ redmine_project }}/wiki/index.json"
        headers:
          X-Redmine-API-Key: "{{ redmine_api_key }}"
      register: request_result
      changed_when: request_result.status in [201, 204]
    - name: 登録済みWikiページを変数に設定
      ansible.builtin.set_fact:
        registerd_wiki_pages: "{{ request_result.json.wiki_pages | items2dict('title', 'version') }}"
    - name: Wikiページの更新
      ansible.builtin.include_tasks:
        file: tasks/update_redmine_wiki_page.yml
      loop: "{{ wiki_pages | default([]) }}"
      loop_control:
        label: "{{ page.name }}"
        loop_var: page
