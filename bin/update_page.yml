# code: language=ansible
---
- name: リクエスト本文の生成
  ansible.builtin.set_fact:
    request_body:
      wiki_page:
        text: "{{ lookup('file', '../' + page.file) }}"
- name: リクエスト本文に親ページの指定を追記
  ansible.builtin.set_fact:
    request_body: "{{ request_body | combine(merge_var, recursive=true) }}"
  when: page.parent is defined
  vars:
    merge_var:
      wiki_page:
        parent_title: "{{ page.parent }}"
- name: 添付ファイルのアップロード
  when:
    - page.attachments is defined
    - page.attachments | length >= 0
  block:
    - name: 変数を初期化
      ansible.builtin.set_fact:
        upload_attachments: []
    - name: 添付ファイルのアップロードしトークンを取得
      ansible.builtin.uri:
        method: POST
        url: "{{ redmine_url }}uploads.json"
        src: "../{{ attachment }}"
        remote_src: true
        return_content: true
        status_code:
          - 200
          - 201
        headers:
          X-Redmine-API-Key: "{{ redmine_api_key }}"
          Content-Type: application/octet-stream
      register: upload_attachment
      loop: "{{ page.attachments }}"
      loop_control:
        loop_var: attachment
    - name: 添付ファイルのトークンを変数を定義
      ansible.builtin.set_fact:
        attachment_tokens: "{{ upload_attachment | json_query('results[].json.upload.token') }}"
    - name: 添付ファイルのMimeTypeを取得
      ansible.builtin.command:
        cmd: file --mime-type ../{{ attachment }}
      register: file_command_result
      loop: "{{ page.attachments }}"
      loop_control:
        loop_var: attachment
    - name: 各添付ファイルのMimeTypeを変数に設定
      ansible.builtin.set_fact:
        attachment_mine_types: "{{ file_command_result | json_query('results[].stdout') | map('regex_replace', '.+: ', '') }}"
    - name: 添付ファイル用リクエスト本文の変数を設定
      ansible.builtin.set_fact:
        upload_attachments: "{{ upload_attachments + [add_attachment] }}"
      vars:
        add_attachment:
          token: "{{ attachment_tokens[ansible_loop.index0] }}"
          filename: "{{ attachment | basename }}"
          content_type: "{{ attachment_mine_types[ansible_loop.index0] }}"
      loop: "{{ page.attachments }}"
      loop_control:
        loop_var: attachment
        extended: true
    - name: リクエスト本文に添付ファイル変数を追加
      ansible.builtin.set_fact:
        request_body: "{{ request_body | combine(merge_var, recursive=true) }}"
      vars:
        merge_var:
          wiki_page:
            uploads: "{{ upload_attachments }}"
- name: Wikiページの更新
  ansible.builtin.uri:
    method: PUT
    url: "{{ redmine_url }}/projects/{{ redmine_project }}/wiki/{{ page.name | urlencode }}.json"
    body: "{{ request_body }}"
    body_format: json
    status_code:
      - 200
      - 201
      - 204
    headers:
      X-Redmine-API-Key: "{{ redmine_api_key }}"
  register: result
- name: Debug
  ansible.builtin.debug:
    var: result
