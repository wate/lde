# code: language=ansible
---
- name: Wikiページの更新
  hosts: all
  become: false
  connection: local
  vars:
    redmine_api_key: "{{ lookup('env', 'REDMINE_API_KEY') }}"
    redmine_url: "{{ lookup('env', 'REDMINE_URL') }}"
    redmine_project: "{{ lookup('env', 'REDMINE_PROJECT') }}"
    wiki_pages:
      - name: Wiki
        file: docs/index.md
      - name: 機能一覧
        file: docs/index.md
      - name: データ構造
        file: docs/er_diagram.md
      - name: システム構成
        file: docs/architecture.md
      - name: デプロイ方法
        file: docs/index.md
  pre_tasks:
    - name: 環境変数の検証
      ansible.builtin.assert:
        that:
          - lookup('env', 'REDMINE_API_KEY') | length > 0
          - lookup('env', 'REDMINE_URL') | length > 0
          - lookup('env', 'REDMINE_PROJECT') | length > 0
        fail_msg: 更新先Redmineを指定する環境変数が設定されていません
  tasks:
    - name: Wikiページの一括更新
      ansible.builtin.uri:
        method: PUT
        url: "{{ redmine_url }}/projects/{{ redmine_project }}/{{ item.name | urlencode }}.json"
        body: "{{ request_body }}"
        body_format: json
        status_code:
          - 200
          - 201
          - 204
        headers:
          X-Redmine-API-Key: "{{ redmine_api_key }}"
      vars:
        request_body:
          wiki_page:
            text: "{{ lookup('file', '../' + item.file) }}"
      loop: "{{ wiki_pages }}"
