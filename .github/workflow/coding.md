実装ワークフロー
=========================

作業フロー
-------------------------

### 作業プラン作成（大規模タスクの場合）

複数日にわたる作業や粒度の大きいタスクの場合、作業開始前に作業プランファイルを作成する。

1. 作業指示書の確認: チケット番号、要件、制約条件を把握
2. 作業プランファイルの作成: タスク分解、技術調査項目、完了条件を整理
3. 過去の指摘事項の確認: 類似作業での指摘を確認し、同様の問題を回避

詳細は[タスク管理ワークフロー](./task-management.md)を参照してください。

### 実装準備

1. 設計の確認: 実装すべき設計内容と技術仕様を把握
2. コーディング規約の確認: プロジェクトのコーディング規約を理解
3. 既存コードの調査: 類似機能や利用可能なユーティリティを確認

### 実装手順

1. テストファースト: 可能な場合、先にテストを作成
2. 最小単位での実装: 小さな単位で実装し、動作確認を繰り返す
3. リファクタリング: 動作確認後、コード品質を改善
4. ドキュメント更新: コメント、README、必要なドキュメントを更新

### 実装完了チェック

1. コーディング規約準拠確認: リンター、フォーマッターで確認
2. テスト実行: ユニットテスト、統合テストの実行
3. エラーハンドリング確認: 正常系・異常系の動作確認
4. パフォーマンス確認: 必要に応じて性能測定

### エラー発生時の対応

実装中にエラーが発生した場合は、以下の手順で対応する。

1. エラー詳細の正確な把握と分類
2. 関連ドキュメント・既存実装での解決策調査
3. 段階的なデバッグによる原因特定
4. 修正内容の影響範囲確認
5. ユーザーへの分かりやすい報告(問題・原因・対策を明示)

絶対遵守ルール
-------------------------

このセクションの全項目は必須です。

### コード作成の基本方針

- 動くコードだけでなく、可読性・テスト可能性・保守性を確保する
- すべての関数・メソッドに日本語Docコメントを記述する
- 変数名・関数名は役割を明確に表す(単文字禁止、ループカウンタのi, j, k、座標のx, y, zは例外)
- 複雑なロジックには「なぜそうするか」をコメントで説明する
- SQL予約語の大文字化: SQLを直接記述する場合、予約語は必ず大文字で記述

### コード品質の原則

- DRY原則: 重複を避け、単一の信頼できる情報源を維持
- プロジェクト全体で一貫したコーディングスタイルを維持
- 小さな問題も放置せず、発見次第修正(Broken Windows理論)

### 問題への対処基準

問題を発見したら、以下の基準で対応する:

- 即座に修正可能(5分以内) → その場で修正
- 修正に時間がかかる → TODOコメント + チケット番号 + 理由を記録
- 設計判断が必要 → ユーザーに報告して指示を仰ぐ
- 判断に迷う → ユーザーに質問(推測で進めない)

### リファクタリングと保守性の方針

- 機能追加と同時に既存コードの改善を検討
- 大規模な変更は小さなステップに分割
- 技術的負債は明示的にコメントやドキュメントに記録

### エラーハンドリングの原則

- 関連が薄く見えるエラーでも必ず解決する
- エラーを抑制するのではなく、根本原因を修正
- 早期にエラーを検出し、明確なエラーメッセージを提供
- エラーケースも必ずテストでカバーする
- 外部APIやネットワーク通信は必ず失敗する可能性を考慮

### セキュリティの考え方

- APIキー、パスワード等はハードコード禁止
- すべての外部入力を検証
- 必要最小限の権限で動作(最小権限の原則)
- セキュリティ監査ツールを定期的に実行

### 禁止領域(AI判断での実装禁止)

以下の領域はセキュリティリスクが高いため、AI判断での実装を禁止します。
実装が必要な場合は必ずユーザーに確認してください。

- 認証・認可処理(ログイン、JWT、OAuth、セッション管理等)
- パスワード処理(ハッシュ化、暗号化、検証ロジック)
- SQL生クエリ生成(特にユーザー入力を含むもの)
- セキュリティ関連HTTPヘッダー設定(CSP, CORS, X-Frame-Options等)
- 外部公開APIのレスポンス構造定義
- 決済処理・金銭計算ロジック
- 暗号化・復号化処理

### 要注意領域(実装後に必ず確認を求める)

以下の領域は実装可能ですが、完了後に必ずユーザーに確認を求めてください。

- ビジネスロジック全般
- 外部API連携処理(例外処理・エラーハンドリングを含む)
- 大規模データを扱う処理(N+1クエリやパフォーマンス影響の可能性)
- ファイル書き込み・アップロード処理(データ永続化、ユーザーファイル受付等)
- データベーススキーマ変更
- 設定ファイルの重要な変更
- 新しい依存関係の追加

推奨ルール
-------------------------

このセクションは推奨事項です。

### 推奨領域(積極的に実装可能)

以下の領域は積極的に実装可能です。
自信を持って提案してください。

- CRUD操作(ORM使用)
- テストコード作成
- 入力バリデーションルール
- ルーティング設定、ミドルウェア雛形
- 単純なユーティリティ関数(文字列操作、日付処理等)
- ログ出力処理
- ファイル読み込み処理(設定ファイル、ログファイル等の参照)

### 実装アプローチ

- 小さなコミット: 論理的に独立した変更を1コミットとする
- テスト駆動開発: 先にテストを書き、実装し、リファクタリング
- ペアプログラミング: 複雑な実装は他の開発者とペアで実施

### パフォーマンスの考慮

- 推測ではなく計測に基づいて最適化
- 初期段階から拡張性を考慮
- 必要になるまでリソースの読み込みを遅延
- キャッシュの有効期限と無効化戦略を明確に
- N+1問題やオーバーフェッチを避ける

### エラーハンドリング

- 早期エラー検出: エラーは発生箇所で即座に検出
- 明確なエラーメッセージ: ユーザーが理解できるエラーメッセージ
- ログ出力: エラー発生時の状況を適切にログ出力

### 信頼性の確保

- タイムアウト処理を適切に設定
- リトライ機構の実装(指数バックオフを考慮)
- サーキットブレーカーパターンの活用
- 一時的な障害に対する耐性を持たせる
- 適切なログとメトリクスで可観測性を確保

### データベース操作の推奨

#### 開発環境でのデータベース接続

- **重要**: 開発環境では接続情報が既に設定済みのため、ホスト・ユーザー名・パスワード・データベース名の指定は不要
- `.myclirc`または`.my.cnf`に接続情報が設定されており、`mycli`または`mysql`コマンドを引数なしで実行可能
- **接続情報を推測して指定しない**: `-h localhost -u root -p root`のような指定は不要であり、誤った情報の可能性がある

#### エラー発生時の対応

- まずユーザーに確認する: 「接続情報なしで実行したところエラーが発生しました。接続設定を確認していただけますか？」
- 推測で接続情報を指定しない: エラー内容をユーザーに報告し、指示を待つ

### 依存関係の管理

- 本当に必要な依存関係のみを追加
- ロックファイルを必ずコミット
- 新しい依存関係追加前にライセンス、サイズ、メンテナンス状況を確認
- セキュリティパッチとバグ修正のため定期的に更新

### 品質確認

- 作業完了前のセルフチェック: 品質基準、コーディング規約、テストカバレッジを確認
- 影響範囲の確認: 変更が他の部分に与える影響を検証
- ドキュメントの同期: コード変更に伴うドキュメント更新を忘れない

参考リンク
-------------------------

### 必須参照ドキュメント

- [コーディング規約](../../docs/code_style.md): 適用すべきルールを確認
- [技術スタック](../../docs/technology.md): 使用技術を把握
- [データベーススキーマ](../../docs/schema/schema.json): データ構造と関連性を把握

### 参考ドキュメント

- [開発作業共通ワークフロー](./development.md): 情報収集の基本手順、Git運用
- [タスク管理ワークフロー](./task-management.md): 作業プランファイルを使った進捗管理
- [セキュリティポリシー](../../docs/security_policy.md): セキュリティ要件の確認
