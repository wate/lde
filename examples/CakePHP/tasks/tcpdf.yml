- name: check exists tcpdf
  ansible.builtin.stat:
    path: "{{ project_dir }}/vendor/tecnickcom/tcpdf"
  register: package_result
- name: setup plugin
  block:
    - name: create fonts directory
      ansible.builtin.file:
        path: "{{ project_dir }}/resources/fonts"
        state: directory
        mode: "0755"
      register: resource_font_dir_result
    - name: generate font files
      block:
        - name: synchronize tcpdf original font files
          ansible.posix.synchronize:
            src: "{{ project_dir }}/vendor/tecnickcom/tcpdf/fonts/"
            dest: "{{ project_dir }}/resources/fonts"
          delegate_to: "{{ inventory_hostname }}"
        - name: find all ttf files
          ansible.builtin.find:
            paths:
              - /usr/share/fonts/opentype/ipaexfont-gothic
              - /usr/share/fonts/opentype/ipaexfont-gothic
              - /usr/share/fonts/opentype/ipafont-gothic
              - /usr/share/fonts/opentype/ipafont-mincho
              - /usr/local/share/fonts/morisawa-biz-ud-gothic
            patterns:
              - '*.ttf'
          register: find_result
        - name: generate tcpdf font file
          ansible.builtin.command:
            cmd: vendor/tecnickcom/tcpdf/tools/tcpdf_addfont.php --outpath {{ project_dir }}/resources/fonts --fonts "{{ item }}"
            chdir: "{{ project_dir }}"
          loop: "{{ find_result.files | map(attribute='path') | list }}"
          tags:
            - skip_ansible_lint
        - name: add TCPDF setting
          ansible.builtin.blockinfile:
            path: "{{ project_dir }}/config/paths.php"
            marker: "// {mark} ANSIBLE MANAGED BLOCK"
            content: |
              define ('K_PATH_FONTS', ROOT . DS . 'resources'. DS . 'fonts' . DS);
      when: resource_font_dir_result is changed
  when: package_result.stat.exists
