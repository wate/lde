---
# code: language=ansible
# Verify mail services
- name: Verify Postfix installation
  tags:
    - verify
    - verify_postfix
  ansible.builtin.assert:
    that:
      - ansible_facts.packages['postfix'] is defined
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Postfix is not installed"
    success_msg: "Postfix is installed"
- name: Verify Postfix is running
  tags:
    - verify
    - verify_postfix
  ansible.builtin.assert:
    that:
      - ansible_facts.services['postfix.service'] is defined
      - ansible_facts.services['postfix.service']['state'] == 'running'
      - ansible_facts.services['postfix.service']['status'] == 'enabled'
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Postfix is not running"
    success_msg: "Postfix is running"
- name: Check Postfix configuration
  ansible.builtin.stat:
    path: /etc/postfix/main.cf
  register: postfix_config_result
- name: Verify Postfix configuration exists
  tags:
    - verify
    - verify_postfix
  ansible.builtin.assert:
    that:
      - postfix_config_result.stat.exists
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Postfix configuration file does not exist"
    success_msg: "Postfix configuration file exists"
- name: Verify Postfix listening port
  tags:
    - verify
    - verify_postfix
  ansible.builtin.assert:
    that:
      - 25 in listen_tcp_posts
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Postfix is not listening on port 25"
    success_msg: "Postfix is listening on port 25"
