---
# code: language=ansible
# Verify backup configuration
- name: Verify Restic installation
  ansible.builtin.assert:
    that:
      - ansible_facts.packages['restic'] is defined
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Restic is not installed"
    success_msg: "Restic is installed"
- name: Check backup base directory
  ansible.builtin.stat:
    path: /backup
  register: backup_base_result
- name: Verify backup base directory
  ansible.builtin.assert:
    that:
      - backup_base_result.stat.exists
      - backup_base_result.stat.isdir
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Backup base directory does not exist"
    success_msg: "Backup base directory exists"
- name: Check backup subdirectories
  ansible.builtin.stat:
    path: "{{ item }}"
  register: backup_subdir_results
  loop:
    - /backup/script
    - /backup/data
    - /backup/repo
    - /backup/password
- name: Verify backup subdirectories
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    quiet: "{{ assert_quiet_mode }}"
    fail_msg: "Backup subdirectory does not exist: {{ item.item }}"
    success_msg: "Backup subdirectory exists: {{ item.item }}"
  loop: "{{ backup_subdir_results.results }}"
  loop_control:
    label: "{{ item.item }}"
