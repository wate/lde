---
- name: Check exists inertia-laravel
  ansible.builtin.stat:
    path: "{{ php_project_tmp_dir }}/vendor/inertiajs/inertia-laravel"
  register: package_result
- name: Setup Inertia
  when: package_result.stat.exists
  block:
    - name: Setup Inertia middleware
      ansible.builtin.command:
        cmd: php artisan inertia:middleware
        creates: "{{ php_project_tmp_dir }}/app/Http/Middleware/HandleInertiaRequests.php"
        chdir: "{{ php_project_tmp_dir }}"
    - name: Add Laravel Inertia Middleware setting
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/app/Http/Kernel.php"
        insertafter: "\\\\Illuminate\\\\Routing\\\\Middleware\\\\SubstituteBindings::class,"
        regex: "\\s*\\\\App\\\\Http\\\\Middleware\\\\HandleInertiaRequests::class,"
        line: "            \\App\\Http\\Middleware\\HandleInertiaRequests::class,"
        firstmatch: true
    - name: Check root template
      ansible.builtin.stat:
        path: "{{ php_project_tmp_dir }}/resources/views/app.blade.php"
      register: root_template_result
    - name: Copy root template
      ansible.builtin.copy:
        src: plugins/inertia/app.blade.php.tpl
        dest: "{{ php_project_tmp_dir }}/resources/views/app.blade.php"
        mode: "0644"
      when: not root_template_result.stat.exists
