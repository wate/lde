---
- name: Check exists localized plugin
  ansible.builtin.stat:
    path: "{{ php_project_tmp_dir }}/vendor/cakephp/localized"
  register: package_result
- name: Setup plugin
  when: package_result.stat.exists
  block:
    - name: Add addPlugin statement
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/Application.php"
        regexp: "this->addPlugin\\('Cake/Localized'\\)"
        line: "        $this->addPlugin('Cake/Localized');"
        insertafter: "// Load more plugins here"
        firstmatch: true
    - name: Create plugin resource directory
      ansible.builtin.file:
        path: "{{ php_project_tmp_dir }}/resources/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - locales
        - locales/ja_JP
      register: resource_locales_dir_result
    - name: Copy po files
      ansible.builtin.copy:
        src: "{{ php_project_tmp_dir }}/vendor/cakephp/localized/resources/locales/ja_JP/cake.po"
        dest: "{{ php_project_tmp_dir }}/resources/locales/ja_JP/cake.po"
        mode: "0644"
        remote_src: true
      when: resource_locales_dir_result is changed
