---
- name: Check exists CakeLte plugin
  ansible.builtin.stat:
    path: "{{ php_project_tmp_dir }}/vendor/arodu/cakelte"
  register: package_result
- name: Setup plugin
  when: package_result.stat.exists
  block:
    - name: Add addPlugin statement
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/Application.php"
        regexp: "this->addPlugin\\('CakeLte'\\)"
        line: "        $this->addPlugin('CakeLte');"
        insertafter: "// Load more plugins here"
        firstmatch: true
    - name: Load CakeLteTrait(1)
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/View/AppView.php"
        line: 'use CakeLte\View\CakeLteTrait;'
        insertafter: '^use Cake\\View\\View;'
    - name: Load CakeLteTrait(2)
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/View/AppView.php"
        line: "    use CakeLteTrait;"
        insertafter: "^\\{"
    - name: Change default layout
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/View/AppView.php"
        line: "    public $layout = 'CakeLte.default';"
        insertafter: "^\\s+use CakeLteTrait;"
    - name: Add parent::initialize() statement
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/View/AppView.php"
        line: "        parent::initialize();"
        insertafter: "^\\s+{"
    - name: Add CakeLte::initializeCakeLte() statement
      ansible.builtin.lineinfile:
        path: "{{ php_project_tmp_dir }}/src/View/AppView.php"
        line: "        $this->initializeCakeLte();"
        insertafter: "^\\s+parent::initialize\\(\\);"
    - name: Check exists plugin config file
      ansible.builtin.stat:
        path: "{{ php_project_tmp_dir }}/config/cakelte.php"
      register: plugin_config_file_result
    - name: Copy plugin config file
      ansible.builtin.copy:
        src: "{{ php_project_tmp_dir }}/vendor/arodu/cakelte/config/cakelte.php"
        dest: "{{ php_project_tmp_dir }}/config/cakelte.php"
        mode: "0644"
        remote_src: true
      when: not plugin_config_file_result.stat.exists
    - name: Copy CakeLte element files
      ansible.builtin.command:
        cmd: "{{ php_project_tmp_dir }}/bin/cake cakelte copy_files -q {{ item }}"
        chdir: "{{ php_project_tmp_dir }}"
        creates: "{{ php_project_tmp_dir }}/templates/plugin/CakeLte/layout"
      loop:
        - content
        - header
        - footer
        - sidebar
    - name: Create CakeLte plugin templates override directory
      ansible.builtin.stat:
        path: "{{ php_project_tmp_dir }}/templates/plugin/CakeLte/layout"
      register: stat_result
    - name: Copy CakeLte plugin override layout files
      when: not stat_result.stat.exists
      block:
        - name: Copy CakeLte plugin override layout files
          ansible.posix.synchronize:
            src: "{{ php_project_tmp_dir }}/vendor/arodu/cakelte/templates/layout/"
            dest: "{{ php_project_tmp_dir }}/templates/plugin/CakeLte/layout"
          delegate_to: "{{ inventory_hostname }}"
    - name: Find CakeLte plugin layout files
      ansible.builtin.find:
        paths:
          - "{{ php_project_tmp_dir }}/templates/plugin/CakeLte/layout"
        patterns:
          - '*.php'
      register: layout_files_result
    - name: Remove annotation
      ansible.builtin.lineinfile:
        path: "{{ item.path }}"
        regexp: '^ \* @var .+ \$this->CakeLte'
        state: absent
      loop: "{{ layout_files_result.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
