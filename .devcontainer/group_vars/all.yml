---
## ---------
## backportsをデフォルトリリースに設定するか否か
## ---------
common_apt_default_release_backports: false

## ---------
## インストールするPHPのバージョン
##
## 対応バージョン：5.6 / 7.0 / 7.1 / 7.2 / 7.3 / 7.4 / 8.0 / 8.2 / **8.2**
## 初期値：8.2
## ---------
php_version: "8.2"

## --------------
## インストールする追加パッケージ
## --------------
cakephp_project_additional_packages: []
#   - name: "josegonzalez/dotenv:^4.0"
#   ## @see https://book.cakephp.org/authentication/2/en/index.html
#   - name: cakephp/authentication
#   ## @see https://book.cakephp.org/authorization/2/en/index.html
#   - name: "cakephp/authorization:^2.0"
#   ## @see https://symfony.com/doc/current/components/yaml.html
#   - name: symfony/yaml
#   ## @see https://github.com/cakephp/localized
#   - name: cakephp/localized
#   ## @see https://github.com/robotusers/cakephp-table-inheritance
#   - name: robotusers/cakephp-table-inheritance
#   ## @see https://phpspreadsheet.readthedocs.io/en/latest/
#   - name: phpoffice/phpspreadsheet
#   ## @see https://github.com/tecnickcom/TCPDF
#   - name: tecnickcom/tcpdf
#   ## @see https://github.com/arodu/cakelte
#   - name: arodu/cakelte
#   ## @see https://csv.thephpleague.com/
#   - name: league/csv:^9.0
#   ## @see https://commonmark.thephpleague.com/
#   - name: league/commonmark
#   ## @see https://book.cakephp.org/queue/1/en/index.html
#   - name: cakephp/queue
#   ## @see https://github.com/squizlabs/PHP_CodeSniffer
#   - name: squizlabs/php_codesniffer
#     dev: true
#   ## @see https://github.com/cakephp/cakephp-codesniffer
#   - name: cakephp/cakephp-codesniffer
#     dev: true
#   ## @see https://phpstan.org/
#   - name: phpstan/phpstan
#     dev: true
#   - name: phpunit/phpunit
#     deb: true
#   ## @see https://fakerphp.github.io/
#   - name: fakerphp/faker
#     dev: true
#   - name: dereuromark/cakephp-ide-helper
#     dev: true
#   ## @see https://github.com/cakedc/cakephp-phpstan
#   - name: cakedc/cakephp-phpstan
#     dev: true
#   ## @see http://zircote.github.io/swagger-php/
#   - name: zircote/swagger-php
#     dev: true

## --------------
## Nginxのバーチャルホストの設定
## --------------
nginx_vhosts:
  - name: default
    default: true
    server_name: "{{ domain }}"
    redirect_hosts:
      - "www.{{ domain }}"
    document_root: /var/www/html{{ (php_project_web_dir | default('') | length > 1) | ternary('/' + php_project_web_dir | default(''), '') }}
    index:
      - index.html
      - index.php
    access_log: /var/log/nginx/access.log
    error_log: /var/log/nginx/error.log
    client_max_body_size: 0
    locations:
      - pattern: /
        content: |
          try_files $uri $uri/ /index.php?$query_string;
      - pattern: "\\.php"
        match_type: "~"
        content: |
          fastcgi_pass unix:/var/run/php/php{{ php_version | default('8.2') }}-fpm.sock;
          include snippets/fastcgi-php.conf;
      - pattern: "/\\.ht"
        match_type: "~"
        content: "deny all;"
    ## Vagrant用設定
    ## @see https://developer.hashicorp.com/vagrant/docs/synced-folders/virtualbox
    extra_setting: |
      sendfile off;
  - name: phpRedisAdmin
    server_name:
      - "cache.{{ domain }}"
    document_root: "{{ phpredisadmin_dest }}"
    index:
      - index.html
      - index.php
    access_log: /var/log/nginx/phpRedisAdmin.access.log
    error_log: /var/log/nginx/phpRedisAdmin.error.log
    client_max_body_size: 0
    locations:
      - pattern: /
        content: |
          try_files $uri $uri/ /index.php?$query_string;
      - pattern: "\\.php"
        match_type: "~"
        content: |
          fastcgi_pass unix:/var/run/php/php{{ php_version | default('8.2') }}-fpm.sock;
          include snippets/fastcgi-php.conf;
      - pattern: "/\\.ht"
        match_type: "~"
        content: "deny all;"
  - name: mailpit
    server_name: "mail.{{ domain }}"
    access_log: /var/log/nginx/mailpit.access.log
    error_log: /var/log/nginx/mailpit.error.log
    client_max_body_size: 0
    pre_extra_setting: |
      map $http_upgrade $connection_upgrade {
          default upgrade;
          ''      close;
      }
    locations:
      - pattern: /
        content: |
          proxy_pass http://127.0.0.1:{{ mailpit_ui_bind_addr.split(':')[1] }};
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          include proxy_params;
      - pattern: "/\\.ht"
        match_type: "~"
        content: "deny all;"
  - name: meilisearch
    server_name: "search.{{ domain }}"
    access_log: /var/log/nginx/meilisearch.access.log
    error_log: /var/log/nginx/meilisearch.error.log
    client_max_body_size: 0
    locations:
      - pattern: /
        content: |
          proxy_pass http://127.0.0.1:{{ meilisearch_port | default('7700') }};
          include proxy_params;
      - pattern: "/\\.ht"
        match_type: "~"
        content: "deny all;"
  - name: grafana
    server_name: "monitor.{{ domain }}"
    access_log: /var/log/nginx/grafana.access.log
    error_log: /var/log/nginx/grafana.error.log
    client_max_body_size: 0
    locations:
      - pattern: /
        content: |
          proxy_pass http://127.0.0.1:{{ grafana_port | default('3000') }};
          include proxy_params;
      - pattern: "/\\.ht"
        match_type: "~"
        content: "deny all;"

## --------------
## Apacheのバーチャルホストの設定
## --------------
apache_vhosts:
  - name: 000-default
    default: true
    server_name: "{{ domain }}"
    document_root: "{{ lde_document_root_path | default('/vagrant', true) }}"
    directory_index:
      - index.html
      - index.php
    options:
      - "-Indexes"
      - "+FollowSymLinks"
    allow_override: All
    custom_log:
      path: /var/log/apache2/access.log
      format: combined
    error_log:
      path: /var/log/apache2/error.log
      log_level: warn
  - name: 090-phpRedisAdmin
    server_name: "cache.{{ domain }}"
    document_root: "{{ phpredisadmin_dest }}"
    directory_index:
      - index.html
      - index.php
    options:
      - "-Indexes"
      - "+FollowSymLinks"
    allow_override: All
    custom_log:
      path: /var/log/apache2/phpRedisAdmin.access.log
      format: combined
    error_log:
      path: /var/log/apache2/phpRedisAdmin.error.log
      log_level: warn
  - name: 091-mailpit
    server_name: "mail.{{ domain }}"
    proxy_pass:
      - from: /
        to: "http://127.0.0.1:{{ mailpit_ui_bind_addr.split(':')[1] }}/"
    proxy_pass_reverse:
      - from: /
        to: "http://127.0.0.1:{{ mailpit_ui_bind_addr.split(':')[1] }}/"
    custom_log:
      path: /var/log/apache2/mailpit.access.log
      format: combined
    error_log:
      path: /var/log/apache2/mailpit.error.log
      log_level: warn
  - name: 092-meilisearch
    server_name: "search.{{ domain }}"
    proxy_pass:
      - from: /
        to: "http://127.0.0.1:{{ meilisearch_port | default('7700') }}/"
    proxy_pass_reverse:
      - from: /
        to: "http://127.0.0.1:{{ meilisearch_port | default('7700') }}/"
    custom_log:
      path: /var/log/apache2/meilisearch.access.log
      format: combined
    error_log:
      path: /var/log/apache2/meilisearch.error.log
      log_level: warn
  - name: 093-grafana
    server_name: "monitor.{{ domain }}"
    proxy_pass:
      - from: /
        to: "http://127.0.0.1:{{ grafana_port | default('3000') }}/"
    proxy_pass_reverse:
      - from: /
        to: "http://127.0.0.1:{{ grafana_port | default('3000') }}/"
    custom_log:
      path: /var/log/apache2/grafana.access.log
      format: combined
    error_log:
      path: /var/log/apache2/grafana.error.log
      log_level: warn

## --------------
## ApacheのVagrant用設定
## @see https://developer.hashicorp.com/vagrant/docs/synced-folders/virtualbox
## --------------
apache_extra_cfg: |
  EnableSendfile off

## ---------
## インストールするPHP関連パッケージ
## ---------
php_packages:
  - php{{ php_version }}-common
  - php{{ php_version }}-cli
  - php{{ php_version }}-dev
  - php{{ php_version }}-curl
  - php{{ php_version }}-gd
  - php{{ php_version }}-bcmath
  - php{{ php_version }}-mbstring
  - php{{ php_version }}-bz2
  - php{{ php_version }}-gettext
  - php{{ php_version }}-sqlite3
  - php{{ php_version }}-mysqlnd
  - php{{ php_version }}-pdo
  - php{{ php_version }}-opcache
  - php{{ php_version }}-intl
  - php{{ php_version }}-imagick
  - php{{ php_version }}-xml
  - php{{ php_version }}-zip
  - php{{ php_version }}-apcu
  - php{{ php_version }}-fpm
  - php{{ php_version }}-redis
  - php{{ php_version }}-xdebug

## ---------
## PHPの設定(cli)
## ---------
php_cli_cfg: |
  date.timezone = Asia/Tokyo
  sendmail_path = /usr/local/bin/mailpit sendmail
## ---------
## PHPの設定(php-fpm)
## ---------
php_fpm_cfg: |
  date.timezone = Asia/Tokyo
  sendmail_path = /usr/local/bin/mailpit sendmail
  [Xdebug]
  xdebug.mode = debug
  xdebug.client_port = 9003
  xdebug.client_host = localhost
  xdebug.start_with_request = yes
## ---------
## PHPの設定(apache)
## ---------
php_apache_cfg: |
  date.timezone = Asia/Tokyo
  sendmail_path = /usr/local/bin/mailpit sendmail
  [Xdebug]
  xdebug.mode = debug
  xdebug.client_port = 9003
  xdebug.client_host = localhost
  xdebug.start_with_request = yes

## --------------
## maipitの環境変数の設定
## --------------
mailpit_envs:
  MP_ENABLE_SPAMASSASSIN: "127.0.0.1:783"

## --------------
## データベースの設定(共通)
## --------------
lde_common_databases:
  dev: &db_app_dev
    name: app_dev
    user: app_dev
    password: app_dev_password
  test: &db_app_test
    name: app_test
    user: app_test
    password: app_test_password
  stg: &db_app_stg
    name: app_stg
    user: app_stg
    password: app_stg_password
  prod: &db_app_prod
    name: app_prod
    user: app_prod
    password: app_prod_password

## --------------
## 接続を許可するホストの設定(MariaDB)
## --------------
lde_common_db_connection_hosts: &mariadb_common_db_connection_hosts
  - "127.0.0.1"
  - "localhost"
  - "192.168.%"
  - "10.0.%"

## --------------
## MariaDBのデータベース設定
## --------------
mariadb_databases:
  - <<: *db_app_dev
    encoding: utf8mb4
    hosts: *mariadb_common_db_connection_hosts
  - <<: *db_app_test
    encoding: utf8mb4
    hosts: *mariadb_common_db_connection_hosts
  - <<: *db_app_stg
    encoding: utf8mb4
    hosts: *mariadb_common_db_connection_hosts
  - <<: *db_app_prod
    encoding: utf8mb4
    hosts: *mariadb_common_db_connection_hosts

## --------------
## 接続を許可するホストの設定(PostgreSQL)
## --------------
postgresql_pg_hba_cfg: |
  # TYPE  DATABASE        USER            ADDRESS                 METHOD
  host    all             all             192.168.56.0/24         md5
  host    all             all             10.0.0.0/8              md5

## --------------
## PostgreSQLのデータベース設定
## --------------
postgresql_databases:
  - <<: *db_app_dev
    encoding: utf8
  - <<: *db_app_test
    encoding: utf8
  - <<: *db_app_stg
    encoding: utf8
  - <<: *db_app_prod
    encoding: utf8

## -----------------
## インストールするpipパッケージ
## -----------------
lde_pip_packages:
  - name: mkdocs-material
    inject_packages:
      - mkdocs-tooltips
      - mkdocs-git-revision-date-localized-plugin
      - mkdocs-exclude
      - mkdocs-redirects
      # - mkdocs-blogging-plugin
  - name: lizard
  - name: ansible
  - name: ansible-lint


## --------------
## CekePHPプロジェクトのデータベース設定
## --------------
cakephp_database_url: "\
  mysql://{{ mariadb_databases[0].user }}:{{ mariadb_databases[0].password }}@localhost/{{ mariadb_databases[0].name }}\
  ?encoding={{ mariadb_databases[0].encoding }}\
  &timezone=UTC\
  &cacheMetadata=true\
  &quoteIdentifiers=false\
  &persistent=false
  "

## --------------
## CekePHPプロジェクトのテスト用データベース設定
## --------------
cakephp_database_test_url: "\
  mysql://{{ mariadb_databases[1].user }}:{{ mariadb_databases[1].password }}@localhost/{{ mariadb_databases[1].name }}\
  ?encoding={{ mariadb_databases[1].encoding }}\
  &timezone=UTC\
  &cacheMetadata=true\
  &quoteIdentifiers=false\
  &persistent=false
  "
