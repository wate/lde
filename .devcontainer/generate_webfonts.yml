---
- name: Convert font
  hosts: all
  vars:
    output_dir: /vagrant/docs/assets/fonts
    find_font_patterns:
      - "*.ttf"
      - "*.otf"
  tasks:
    - name: Create working directory
      ansible.builtin.file:
        path: /tmp/font_work
        state: directory
        mode: "0755"
    - name: Create subset text file
      ansible.builtin.template:
        src: subset_all.txt.j2
        dest: "{{ output_dir }}/subset.txt"
        mode: "0644"
      vars:
        subset_files:
          - files/subset_alphanumeric.txt
          - files/subset_symbol.txt
          - files/subset_fullwidth_alphanumeric.txt
          - files/subset_fullwidth_symbol.txt
          - files/subset_hiragana.txt
          - files/subset_katakana.txt
          - files/subset_kanji.txt
    - name: Find convert font files
      ansible.builtin.find:
        path:
          - /usr/share/fonts/truetype/bizud-gothic
          - /usr/share/fonts/truetype/bizud-mincho
          - /usr/share/fonts/opentype/ipaexfont-gothic
          - /usr/share/fonts/opentype/ipaexfont-mincho
          - /usr/share/fonts/opentype/ipafont-gothic
          - /usr/share/fonts/opentype/ipafont-mincho
          - /usr/local/share/fonts
        patterns: "{{ find_font_patterns }}"
        recurse: true
      register: find_src_result
    - name: Create font subset
      ansible.builtin.command:
        cmd: >
          fonttools subset
          --text-file={{ output_dir }}/subset.txt
          --output-file={{ output_dir }}/{{ item.path | basename }}
          {{ item.path }}
        chdir: "{{ output_dir }}"
      loop: "{{ find_src_result.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
    - name: Find convert font files
      ansible.builtin.find:
        path:
          - "{{ output_dir }}"
        patterns:
          - "*.ttf"
          - "*.otf"
      register: find_subset_result
    - name: Convert woff
      ansible.builtin.command:
        cmd: sfnt2woff {{ item.path }}
        chdir: "{{ output_dir }}"
      loop: "{{ find_subset_result.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
    - name: Convert woff2
      ansible.builtin.command:
        cmd: woff2_compress {{ item.path }}
        chdir: "{{ output_dir }}"
      loop: "{{ find_subset_result.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
