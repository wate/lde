---
# code: language=ansible
# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json
- name: 仮想マシンの検証
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Verify local development environment
      tags:
        - verify
      block:
        - name: PHP-FPMのパッケージ名/サービス名を変数に設定
          ansible.builtin.set_fact:
            php_fpm_name: "php{{ php_version | default('8.2') }}-fpm"
        ## パッケージ
        - name: インストール済みパッケージの情報を取得
          ansible.builtin.package_facts:
            manager: auto
        - name: パッケージのインストール状況を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.packages['mariadb-server'] is defined
              - ansible_facts.packages[php_fpm_name] is defined
              - ansible_facts.packages['nginx'] is defined
              - ansible_facts.packages['redis'] is defined
        ## ファイル・ディレクトリ
        - name: シンボリックリンクの確認
          become: false
          block:
            - name: ソースコードディレクトリのシンボリックリンクの確認
              ansible.builtin.stat:
                path: ~/src
              register: src_symlink_result
            - name: シンボリックリンクの検証
              ansible.builtin.assert:
                that:
                  - src_symlink_result.stat.exists
                  - src_symlink_result.stat.islnk
                  - src_symlink_result.stat.lnk_target == '/vagrant'
        ## サービスのテスト
        - name: サービスの情報を取得
          ansible.builtin.service_facts:
        - name: MariaDBの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services['mariadb.service'] is defined
              - ansible_facts.services['mariadb.service']['state'] == 'running'
              - ansible_facts.services['mariadb.service']['status'] == 'enabled'
        - name: PHP-FPMの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services[php_fpm_name + '.service'] is defined
              - ansible_facts.services[php_fpm_name + '.service']['state'] == 'running'
              - ansible_facts.services[php_fpm_name + '.service']['status'] == 'enabled'
        - name: Nginxの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services['nginx.service'] is defined
              - ansible_facts.services['nginx.service']['state'] == 'running'
              - ansible_facts.services['nginx.service']['status'] == 'enabled'
        - name: SpamAssasinデーモンの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services['spamd.service'] is defined
              - ansible_facts.services['spamd.service']['state'] == 'running'
              - ansible_facts.services['spamd.service']['status'] == 'enabled'
        - name: Mailpitデーモンの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services['mailpit.service'] is defined
              - ansible_facts.services['mailpit.service']['state'] == 'running'
              - ansible_facts.services['mailpit.service']['status'] == 'enabled'
        - name: Redisの稼働状態を検証
          ansible.builtin.assert:
            that:
              - ansible_facts.services['redis-server.service'] is defined
              - ansible_facts.services['redis-server.service']['state'] == 'running'
              - ansible_facts.services['redis-server.service']['status'] == 'enabled'
        ## 待受ポート
        - name: 待受ポートの情報を取得
          community.general.listen_ports_facts:
            command: ss
        - name: 取得した待受ポートの情報を加工してテスト用変数に格納
          ansible.builtin.set_fact:
            listen_tcp_posts: "{{ ansible_facts.tcp_listen | map(attribute='port') | unique | sort | list }}"
            listen_udp_posts: "{{ ansible_facts.udp_listen | map(attribute='port') | unique | sort | list }}"
        - name: 待受ポートを検証
          ansible.builtin.assert:
            that:
              ## Nginx / Apache
              - 80 in listen_tcp_posts
              ## MariaDB
              - 3306 in listen_tcp_posts
              ## spamd
              - 783 in listen_tcp_posts
              ## redis
              - 6379 in listen_tcp_posts
              ## mailpit
              - 1025 in listen_tcp_posts
              - 8025 in listen_tcp_posts
              ## meilisearch
              - 7700 in listen_tcp_posts
              ## grafana
              - 3000 in listen_tcp_posts
