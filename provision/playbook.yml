- name: setup local development environment
  hosts: all
  become: true
  roles:
    - name: common
      tags: role_common
    - name: nodejs
      tags: role_nodejs
    - name: mariadb
      tags: role_mariadb
    - name: dehydrated
      tags: role_dehydrated
    - name: apache
      tags: role_apache
    - name: php
      tags: role_php
    - name: redis
      tags: role_redis
    - name: tools
      tags: role_tools
  pre_tasks:
    - name: set pre task files
      set_fact:
        pre_task_file: "{{ lookup('first_found', pre_task_files, errors='ignore') }}"
      vars:
        pre_task_files:
          files:
            - pre_task.yml
          paths:
            - ..
            - .
    - name: execute pre task
      include_tasks: "{{ pre_task_file }}"
      when: pre_task_file | length > 0
  tasks:
    - block:
      - name: create scripts
        template:
          src: "{{ item }}"
          dest: ~/{{ item[:-3] | basename }}
          mode: "0700"
        with_fileglob: scripts/*.j2
      become: false
    - name: change owner on document root directory
      file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
    # - name: create mysql connection file
    #   ini_file:
    #     path: ~/.my.cnf
    #     create: true
    #     section: client
    #     option: "{{ item.key | replace('_', '-') }}"
    #     value: "{{ item.value | string }}"
    #   with_dict:
    #     host: localhost
    #     database: "{{ mariadb_databases[0].name }}"
    #     user: "{{ mariadb_databases[0].user | default(mariadb_databases[0].name) }}"
    #     password: "{{ mariadb_databases[0].password | default(mariadb_databases[0].user) }}"
    #     default_character_set: "{{ mariadb_databases[0].encoding | default(mariadb_default_charset) }}"
    #   become: false
    #   tags: my.cnf
    # - name: restart service
    #   systemd:
    #     name: "{{ item }}"
    #     state: restarted
    #   loop:
    #     - httpd
    #     - mariadb
    # - name: restart service(cache server)
    #   systemd:
    #     name: "{{ cache_server }}"
    #     state: restarted
    #   when:
    #     - cache_server is defined
    #     - cache_server in ['redis', 'memcached']
    # - block:
    #     - name: install github deploykey
    #       copy:
    #         src: "{{ github_deploykey_path }}"
    #         dest: ~/.ssh/github_deploykey
    #         mode: '0600'
    #         remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
    #       when: github_deploykey_path is defined
    #     - name: install bitbucket deploykey
    #       copy:
    #         src: "{{ bitbucket_deploykey_path }}"
    #         dest: ~/.ssh/bitbucket_deploykey
    #         mode: '0600'
    #         remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
    #       when: bitbucket_deploykey_path is defined
    #     - name: install gitlab deploykey
    #       copy:
    #         src: "{{ gitlab_deploykey_path }}"
    #         dest: ~/.ssh/gitlab_deploykey
    #         mode: '0600'
    #         remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
    #       when: gitlab_deploykey_path is defined
    #     - name: install backlog ssh key
    #       copy:
    #         src: "{{ backlog_deploykey_path }}"
    #         dest: ~/.ssh/backlog_deploykey
    #         mode: '0600'
    #         remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
    #       when: backlog_deploykey_path is defined
    #     - name: Insert/Update ssh configuration block in ~/.ssh/config
    #       blockinfile:
    #         path: ~/.ssh/config
    #         block: |
    #           {% if github_deploykey_path is defined -%}
    #           Host github.com
    #             IdentityFile ~/.ssh/github_deploykey
    #             StrictHostKeyChecking no
    #             User git
    #           {% endif %}
    #           {% if bitbucket_deploykey_path is defined -%}
    #           Host bitbucket.org
    #             IdentityFile ~/.ssh/bitbucket_deploykey
    #             StrictHostKeyChecking no
    #             User git
    #           {% endif %}
    #           {% if gitlab_deploykey_path is defined -%}
    #           Host gitlab.com
    #             IdentityFile ~/.ssh/gitlab_deploykey
    #             StrictHostKeyChecking no
    #             User git
    #           {% endif %}
    #           {% if backlog_deploykey_path is defined -%}
    #           Host *.git.backlog.jp
    #             IdentityFile ~/.ssh/backlog_deploykey
    #             StrictHostKeyChecking no
    #           {% endif %}
    #         create: true
    #         mode: "0600"
    #   become: false
  post_tasks:
    - name: set other post task files
      set_fact:
        post_task_file: "{{ lookup('first_found', post_task_files, errors='ignore') }}"
        app_setup_file: "{{ lookup('first_found', app_setup_files, errors='ignore') }}"
      vars:
        post_task_files:
          files:
            - post_task.yml
          paths:
            - ..
            - .
        app_setup_files:
          files:
            - app.yml
            - setup.yml
            - setup_app.yml
            - app_setup.yml
            - deploy.yml
          paths:
            - ..
            - .
    - name: execute post task
      include_tasks: "{{ post_task_file }}"
      when: post_task_file | length > 0
    - name: setup application
      include_tasks: "{{ app_setup_file }}"
      when: app_setup_file | length > 0
