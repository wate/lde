- name: setup local development environment
  hosts: all
  become: true
  roles:
    - name: common
      tags: role_common
    - name: nodejs
      tags: role_nodejs
    - name: mariadb
      tags: role_mariadb
    - name: dehydrated
      tags: role_dehydrated
    - name: apache
      tags: role_apache
    - name: php
      tags: role_php
    - name: redis
      tags: role_redis
    - name: tools
      tags: role_tools
    - name: phpredisadmin
      tags: role_phpredisadmin
  pre_tasks:
    - name: set pre task files
      set_fact:
        pre_task_file: "{{ lookup('first_found', pre_task_files, errors='ignore') }}"
      vars:
        pre_task_files:
          files:
            - pre_task.yml
          paths:
            - ..
            - .
    - name: execute pre task
      include_tasks: "{{ pre_task_file }}"
      when: pre_task_file | length > 0
  tasks:
    - block:
        - name: create scripts
          template:
            src: "{{ item }}"
            dest: ~/{{ item[:-3] | basename }}
            mode: "0700"
          loop: "{{ lookup('fileglob', 'scripts/*.j2', wantlist=True)  }}"
      become: false
    - name: change owner on document root directory
      file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
    - name: restart service
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - apache2
        - mariadb
        - redis
    - name: add/update user setting
      import_tasks: my.yml
  post_tasks:
    - name: set other post task files
      set_fact:
        post_task_file: "{{ lookup('first_found', post_task_files, errors='ignore') }}"
        app_setup_file: "{{ lookup('first_found', app_setup_files, errors='ignore') }}"
      vars:
        post_task_files:
          files:
            - post_task.yml
          paths:
            - ..
            - .
        app_setup_files:
          files:
            - app.yml
            - setup.yml
            - setup_app.yml
            - app_setup.yml
            - deploy.yml
          paths:
            - ..
            - .
    - name: execute post task
      include_tasks: "{{ post_task_file }}"
      when: post_task_file | length > 0
    - name: setup application
      include_tasks: "{{ app_setup_file }}"
      when: app_setup_file | length > 0
