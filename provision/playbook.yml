- name: setup local development environment
  hosts: all
  become: true
  roles:
    - name: common
      tags: role_common
    - name: mackerel_agent
      tags: role_mackerel_agent
    - name: nodejs
      tags: role_nodejs
    - name: mariadb
      tags: role_database_server
    - name: dehydrated
      tags: role_dehydrated
    - name: php
      tags: role_php
    - name: "{{ 'apache' if (web_server | default('apache')) == 'apache' else 'nginx' }}"
      tags: role_web_server
    - name: redis
      tags: role_redis
    - name: tools
      tags: role_tools
    - name: phpmyadmin
      tags: role_phpmyadmin
    - name: phpredisadmin
      tags: role_phpredisadmin
  pre_tasks:
    - name: set pre task files
      ansible.builtin.set_fact:
        pre_task_file: "{{ lookup('first_found', pre_task_files, errors='ignore') }}"
      vars:
        pre_task_files:
          files:
            - pre_task.yml
          paths:
            - ..
            - .
    - name: execute pre task
      ansible.builtin.include_tasks: "{{ pre_task_file }}"
      when: pre_task_file | length > 0
  tasks:
    - name: change owner on document root directory
      ansible.builtin.file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
    - name: set service name variable
      ansible.builtin.set_fact:
        web_server_service: "{{ 'apache2' if (web_server | default('apache')) == 'apache' else 'nginx' }}"
    - name: restart service
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - "{{ web_server_service }}"
        - mariadb
    - name: set variables(database connection_setting)
      ansible.builtin.set_fact:
        lde_db_host: localhost
        lde_db_name: "{{ mariadb_databases[0]['name'] }}"
        lde_db_user: "{{ mariadb_databases[0]['user'] | default(mariadb_databases[0]['name']) }}"
        lde_db_password: "{{ mariadb_databases[0]['password'] }}"
        lde_db_encoding: "{{ mariadb_databases[0].encoding | default('utf8mb4') }}"
    - name: add/update user setting
      ansible.builtin.import_tasks: my.yml
  post_tasks:
    - name: create sorce directory symlink
      ansible.builtin.file:
        path: ~/src
        src: /vagrant/src
        state: link
      become: false
    - name: set other post task files
      ansible.builtin.set_fact:
        post_task_file: "{{ lookup('first_found', post_task_files, errors='ignore') }}"
      vars:
        post_task_files:
          files:
            - post_task.yml
          paths:
            - ..
            - .
    - name: execute post task
      block:
        - name: set variable for post task file base directory
          ansible.builtin.set_fact:
            post_task_base_dir: "{{ post_task_file | dirname }}"
        - name: execute post task
          ansible.builtin.include_tasks: "{{ post_task_file }}"
      when: post_task_file | length > 0
