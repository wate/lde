- name: setup local development environment
  hosts: all
  become: true
  roles:
    - role: common
      tags: role_common
    - role: python
      tags: role_python
    - role: ruby
      tags: role_ruby
    - role: nodejs
      tags: role_nodejs
    - role: mariadb
      tags: role_mariadb
    - role: lexicon
      tags: role_lexicon
    - role: dehydrated
      tags: role_dehydrated
    - role: apache
      tags: role_apache
    - role: php
      tags: role_php
    - role: mailhog
      tags: role_mailhog
    - role: wp-cli
      tags: role_wp-cli
    - role: phpmyadmin
      tags: role_phpmyadmin
    - role: wwwsqldesigner
      tags: role_wwwsqldesigner
    - role: xhgui
      tags: role_xhgui
  vars:
    tbls_version: "1.7.1"
    tideware_version: 4.x
    tideware_extension_name: tideways
  tasks:
    - name: install php xdebug module
      yum:
        name: php-pecl-xdebug
      when: php_xdebug_installed|default(false)
    - name: install php tideways module
      block:
        - name: install php-devel package
          yum:
            name: php-devel
        - name: checkout source
          git:
            repo: https://github.com/tideways/php-profiler-extension.git
            dest: /usr/local/src/php-profiler-extension
            version: "{{ tideware_version }}"
          register: result
        - block:
            - name: build extension(phpize)
              command: phpize
              args:
                chdir: /usr/local/src/php-profiler-extension
            - name: build extension(./configure)
              command: ./configure
              args:
                chdir: /usr/local/src/php-profiler-extension
            - name: build extension(make)
              command: make
              args:
                chdir: /usr/local/src/php-profiler-extension
            - name: build extension(make install)
              command: make install
              args:
                chdir: /usr/local/src/php-profiler-extension
          when: result is changed
        - name: create extension config file
          lineinfile:
            path: /etc/php.d/20-tideways.ini
            regexp: ^#?\s*extension=.*
            line: "extension={{ tideware_extension_name }}{{ '.so' if php_version is version('7.2', '<') else '' }}"
            create: true
      when: php_tideways_profiler_installed|default(false)
    - name: install the silver searcher
      yum:
        name: the_silver_searcher
    - name: install graphviz
      yum:
        name: graphviz
    - name: download tbls
      get_url:
        url: https://github.com/k1LoW/tbls/releases/download/v{{ tbls_version }}/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
        dest: /usr/local/src/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
    - name: unarchive tbls archive file
      unarchive:
        src: /usr/local/src/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
        dest: /usr/local/bin
        exclude:
          - LICENSE
          - README.md
          - CHANGELOG.md
        extra_opts:
          - '--strip=1'
        owner: root
        group: root
        remote_src: true
    - block:
      - name: create scripts
        template:
          src: "{{ item }}"
          dest: ~/{{ item[:-3]|basename }}
          mode: "0700"
        with_fileglob: scripts/*.j2
      become: false
    - block:
      - name: check global composer setting
        stat:
          path: ~/.config/composer/composer.json
        register: result
      - name: install prestissimo(composer plugin) for vagrant
        composer:
          command: require
          global_command: true
          arguments: hirak/prestissimo
        when: not result.stat.exists
      - name: update global composer packages
        composer:
          command: update
          global_command: true
        when: result.stat.exists
      become: false
      tags: prestissimo
    - name: change group
      file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
      when: apache_vhosts[0].document_root != '/var/www/html'
    - name: setup WordPress
      import_tasks: wordpress.yml
      when: app_type.startswith('wordpress')
      tags: wordpress
    - name: setup EC-CUBE
      import_tasks: ec-cube.yml
      when: app_type.startswith('ec-cube')
      tags: ec-cube
    - name: create mysql connection file
      ini_file:
        path: ~/.my.cnf
        create: true
        section: client
        option: "{{ item.key|replace('_', '-') }}"
        value: "{{ item.value }}"
      with_dict:
        host: localhost
        database: "{{ mariadb_databases[0].name }}"
        user: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
        password: "{{ mariadb_databases[0].password|default(mariadb_databases[0].user) }}"
        default_character_set: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
      become: false
      tags: my.cnf
    - block:
        - name: install pip
          yum:
            name: python2-pip
        - name: install mycli
          pip:
            name: mycli
        - name: create mycli main setting file
          ini_file:
            path: ~/.myclirc
            create: true
            section: main
            option: "{{ item.key }}"
            value: "{{ item.value }}"
          with_dict: "{{ mycli_main_cfg }}"
          become: false
        - name: add mycli dsn alias
          ini_file:
            path: ~/.myclirc
            create: true
            section: alias_dsn
            option: "{{ item.key }}"
            value: "{{ item.value }}"
          with_dict: "{{ mycli_alias_dsn }}"
          become: false
        - name: create mycli connection setting file
          ini_file:
            path: ~/.myclirc
            create: true
            section: client
            option: "{{ item.key|replace('_', '-') }}"
            value: "{{ item.value }}"
          with_dict:
            host: localhost
            database: "{{ mariadb_databases[0].name }}"
            user: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
            password: "{{ mariadb_databases[0].password|default(mariadb_databases[0].user) }}"
            default_character_set: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
            skip_pager: false
          become: false
      tags: mycli
    - name: restart service
      systemd:
        name: "{{ item }}"
        state: restarted
      with_items:
        - httpd
        - mariadb
    - name: setup application
      include_tasks: "{{ setup_file }}"
      with_first_found:
        - files:
            - app.yml
            - setup.yml
            - setup_app.yml
            - app_setup.yml
          skip: true
      loop_control:
        loop_var: setup_file
    - name: execute post tasks
      include_tasks: "{{ post_task_file }}"
      with_first_found:
        - files:
            - ../post_task.yml
          skip: true
      loop_control:
        loop_var: post_task_file
