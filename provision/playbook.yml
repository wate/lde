- name: setup local development environment
  hosts: all
  become: true
  roles:
    - role: common
      tags: role_common
    - role: python
      tags: role_python
    - role: ruby
      tags: role_ruby
    - role: nodejs
      tags: role_nodejs
    - role: mariadb
      tags: role_mariadb
    - role: lexicon
      tags: role_lexicon
    - role: dehydrated
      tags: role_dehydrated
    - role: apache
      tags: role_apache
    - role: php
      tags: role_php
    - role: mailhog
      tags: role_mailhog
    - role: wp-cli
      tags: role_wp-cli
    - role: phpmyadmin
      tags: role_phpmyadmin
    - role: wwwsqldesigner
      tags: role_wwwsqldesigner
  vars:
    tbls_version: "1.40.0"
    tideware_version: "4.x"
    tideware_extension_name: tideways
  tasks:
    - name: install Google Noto Fonts
      yum:
        name:
          - google-noto-cjk-fonts
          - google-noto-sans-cjk-fonts
          - google-noto-sans-japanese-fonts
    - name: install php xdebug module
      yum:
        name: php-pecl-xdebug
      when: php_xdebug_installed | default(false)
    - name: install the silver searcher
      yum:
        name: the_silver_searcher
    - name: install graphviz
      yum:
        name: graphviz
    - name: install nkf
      yum:
        name: nkf
    - name: install tbls
      yum:
        name: https://github.com/k1LoW/tbls/releases/download/v{{ tbls_version }}/tbls_{{ tbls_version }}-1_amd64.rpm
    - block:
      - name: create scripts
        template:
          src: "{{ item }}"
          dest: ~/{{ item[:-3] | basename }}
          mode: "0700"
        with_fileglob: scripts/*.j2
      become: false
    - block:
        - name: check global composer setting
          stat:
            path: ~/.config/composer/composer.json
          register: result
        - name: install prestissimo(composer plugin) for vagrant
          composer:
            command: require
            global_command: true
            arguments: hirak/prestissimo
          when: not result.stat.exists
        - name: update global composer packages
          composer:
            command: update
            global_command: true
          when: result.stat.exists
      become: false
      tags: prestissimo
      when: install_prestissimo | default(false)
    - name: change owner on document root directory
      file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
    - name: setup WordPress
      import_tasks: wordpress.yml
      become: false
      when: app_type.startswith('wordpress')
      tags: wordpress
    - name: setup EC-CUBE
      import_tasks: ec-cube.yml
      when: app_type.startswith('ec-cube')
      tags: ec-cube
    - name: create mysql connection file
      ini_file:
        path: ~/.my.cnf
        create: true
        section: client
        option: "{{ item.key | replace('_', '-') }}"
        value: "{{ item.value | string }}"
      with_dict:
        host: localhost
        database: "{{ mariadb_databases[0].name }}"
        user: "{{ mariadb_databases[0].user | default(mariadb_databases[0].name) }}"
        password: "{{ mariadb_databases[0].password | default(mariadb_databases[0].user) }}"
        default_character_set: "{{ mariadb_databases[0].encoding | default(mariadb_default_charset) }}"
      become: false
      tags: my.cnf
    # - block:
    #     - name: install pip
    #       yum:
    #         name: python2-pip
    #     - name: install mycli
    #       pip:
    #         name: mycli
    #     - name: create mycli main setting file
    #       ini_file:
    #         path: ~/.myclirc
    #         create: true
    #         section: main
    #         option: "{{ item.key }}"
    #         value: "{{ item.value | string }}"
    #       with_dict: "{{ mycli_main_cfg }}"
    #       become: false
    #     - name: add mycli dsn alias
    #       ini_file:
    #         path: ~/.myclirc
    #         create: true
    #         section: alias_dsn
    #         option: "{{ item.key }}"
    #         value: "{{ item.value | string }}"
    #       with_dict: "{{ mycli_alias_dsn }}"
    #       become: false
    #     - name: create mycli connection setting file
    #       ini_file:
    #         path: ~/.myclirc
    #         create: true
    #         section: client
    #         option: "{{ item.key|replace('_', '-') }}"
    #         value: "{{ item.value | string }}"
    #       with_dict:
    #         host: localhost
    #         database: "{{ mariadb_databases[0].name }}"
    #         user: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
    #         password: "{{ mariadb_databases[0].password|default(mariadb_databases[0].user) }}"
    #         default_character_set: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
    #         skip_pager: false
    #       become: false
    #   tags: mycli
    - name: restart service
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - httpd
        - mariadb
    - block:
        - name: install github deploykey
          copy:
            src: "{{ github_deploykey_path }}"
            dest: ~/.ssh/github_deploykey
            mode: '0600'
            remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
          when: github_deploykey_path is defined
        - name: install bitbucket deploykey
          copy:
            src: "{{ bitbucket_deploykey_path }}"
            dest: ~/.ssh/bitbucket_deploykey
            mode: '0600'
            remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
          when: bitbucket_deploykey_path is defined
        - name: install gitlab deploykey
          copy:
            src: "{{ gitlab_deploykey_path }}"
            dest: ~/.ssh/gitlab_deploykey
            mode: '0600'
            remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
          when: gitlab_deploykey_path is defined
        - name: install backlog ssh key
          copy:
            src: "{{ backlog_deploykey_path }}"
            dest: ~/.ssh/backlog_deploykey
            mode: '0600'
            remote_src: "{{ true if vagrant_provisioner == 'anslble_local' else false }}"
          when: backlog_deploykey_path is defined
        - name: Insert/Update ssh configuration block in ~/.ssh/config
          blockinfile:
            path: ~/.ssh/config
            block: |
              {% if github_deploykey_path is defined -%}
              Host github.com
                IdentityFile ~/.ssh/github_deploykey
                StrictHostKeyChecking no
                User git
              {% endif %}
              {% if bitbucket_deploykey_path is defined -%}
              Host bitbucket.org
                IdentityFile ~/.ssh/bitbucket_deploykey
                StrictHostKeyChecking no
                User git
              {% endif %}
              {% if gitlab_deploykey_path is defined -%}
              Host gitlab.com
                IdentityFile ~/.ssh/gitlab_deploykey
                StrictHostKeyChecking no
                User git
              {% endif %}
              {% if backlog_deploykey_path is defined -%}
              Host *.git.backlog.jp
                IdentityFile ~/.ssh/backlog_deploykey
                StrictHostKeyChecking no
              {% endif %}
            create: true
            mode: "0600"
      become: false
    - name: set other task files
      set_fact:
        post_task_file: "{{ lookup('first_found', post_task_files, errors='ignore') }}"
        app_setup_file: "{{ lookup('first_found', app_setup_files, errors='ignore') }}"
      vars:
        post_task_files:
          files:
            - post_task.yml
          paths:
            - ..
            - .
        app_setup_files:
          files:
            - app.yml
            - setup.yml
            - setup_app.yml
            - app_setup.yml
            - deploy.yml
          paths:
            - ..
            - .
    - name: execute post tasks
      include_tasks: "{{ post_task_file }}"
      when: (post_task_file | length) > 0
    - name: setup application
      include_tasks: "{{ app_setup_file }}"
      when: (app_setup_file | length) > 0
