- name: setup local development environment
  hosts: all
  become: true
  roles:
    - role: common
      tags: role_common
    - role: python
      tags: role_python
    - role: ruby
      tags: role_ruby
    - role: nodejs
      tags: role_nodejs
    - role: mariadb
      tags: role_mariadb
    - role: lexicon
      tags: role_lexicon
    - role: dehydrated
      tags: role_dehydrated
    - role: apache
      tags: role_apache
    - role: php
      tags: role_php
    - role: mailhog
      tags: role_mailhog
    - role: wp-cli
      tags: role_wp-cli
    - role: phpmyadmin
      tags: role_phpmyadmin
    - role: wwwsqldesigner
      tags: role_wwwsqldesigner
    - role: pagegenerator
      tags: role_pagegenerator
  vars:
    tbls_version: "1.3.0"
  tasks:
    - name: install the silver searcher
      yum:
        name: the_silver_searcher
    - name: install graphviz
      yum:
        name: graphviz
    - name: download tbls
      get_url:
        url: https://github.com/k1LoW/tbls/releases/download/v{{ tbls_version }}/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
        dest: /usr/local/src/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
    - name: unarchive tbls archive file
      unarchive:
        src: /usr/local/src/tbls_v{{ tbls_version }}_linux_amd64.tar.gz
        dest: /usr/local/bin
        exclude:
          - LICENSE
          - README.md
          - CHANGELOG.md
        extra_opts:
          - '--strip=1'
        owner: root
        group: root
        remote_src: true
    - block:
      - name: create scripts
        template:
          src: "{{ item }}"
          dest: ~/{{ item[:-3]|basename }}
          mode: "0700"
        with_fileglob: scripts/*.j2
      become: false
    - block:
      - name: check global composer setting
        stat:
          path: ~/.config/composer/composer.json
        register: result
      - name: install prestissimo(composer plugin) for vagrant
        composer:
          command: require
          global_command: true
          arguments: hirak/prestissimo
        when: not result.stat.exists
      - name: update global composer packages
        composer:
          command: update
          global_command: true
        when: result.stat.exists
      become: false
      tags: prestissimo
    - name: change group
      file:
        path: /var/www/html
        recurse: true
        follow: false
        owner: vagrant
        group: vagrant
        state: directory
    - name: setup WordPress
      import_tasks: wordpress.yml
      when: app_type.startswith('wordpress')
      tags: wordpress
    - name: setup EC-CUBE
      import_tasks: ec_cube.yml
      when: app_type.startswith('ec_cube')
      tags: ec_cube
    - name: create mysql connection file
      ini_file:
        path: ~/.my.cnf
        create: true
        section: client
        option: "{{ item.key|replace('_', '-') }}"
        value: "{{ item.value }}"
      with_dict:
        host: localhost
        database: "{{ mariadb_databases[0].name }}"
        user: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
        password: "{{ mariadb_databases[0].password|default(mariadb_databases[0].user) }}"
        default_character_set: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
      become: false
      tags: my.cnf
    - block:
        - name: install pip
          yum:
            name: python2-pip
        - name: install mycli
          pip:
            name: mycli
        - name: create mycli main setting file
          ini_file:
            path: ~/.myclirc
            create: true
            section: main
            option: "{{ item.key }}"
            value: "{{ item.value }}"
          with_dict: "{{ mycli_main_cfg }}"
          become: false
        - name: add mycli dsn alias
          ini_file:
            path: ~/.myclirc
            create: true
            section: alias_dsn
            option: "{{ item.key }}"
            value: "{{ item.value }}"
          with_dict: "{{ mycli_alias_dsn }}"
          become: false
        - name: create mycli connection setting file
          ini_file:
            path: ~/.myclirc
            create: true
            section: client
            option: "{{ item.key|replace('_', '-') }}"
            value: "{{ item.value }}"
          with_dict:
            host: localhost
            database: "{{ mariadb_databases[0].name }}"
            user: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
            password: "{{ mariadb_databases[0].password|default(mariadb_databases[0].user) }}"
            default_character_set: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
            skip_pager: on
          become: false
      tags: mycli
    - name: restart service
      systemd:
        name: "{{ item }}"
        state: restarted
      with_items:
        - httpd
        - mariadb
