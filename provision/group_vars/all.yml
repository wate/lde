
# --------------
# PHPのバージョン
#
# 指定可能な値は以下の通り
# - 7.0
# - 7.1
# - 7.2
# - 7.3
# - 7.4
# - 8.0
# --------------
php_version: "7.4"

# --------------
# インストールするPHPのパッケージ
# --------------
php_packages:
  - php{{ php_version }}-common
  - php{{ php_version }}-cli
  - php{{ php_version }}-dev
  - php{{ php_version }}-curl
  - php{{ php_version }}-gd
  - php{{ php_version }}-bcmath
  - php{{ php_version }}-imagick
  - php{{ php_version }}-mbstring
  - php{{ php_version }}-mcrypt
  - php{{ php_version }}-gettext
  - php{{ php_version }}-sqlite3
  - php{{ php_version }}-mysqlnd
  - php{{ php_version }}-json
  - php{{ php_version }}-pdo
  - php{{ php_version }}-opcache
  - php{{ php_version }}-intl
  - php{{ php_version }}-xml
  - php{{ php_version }}-zip
  - php{{ php_version }}-apcu
  - php{{ php_version }}-redis
  - php{{ php_version }}-fpm

# --------------
# php.iniの初期値を上書きする項目
# その他の設定値は、「provision/roles/php/defaults/main.yml」の「php_cfg」の項目を参照
# --------------
php_cfg: |
  display_errors = On
  memory_limit = 512M
  date.timezone = Asia/Tokyo
  sendmail_path =/usr/local/bin/mhsendmail

# --------------
# MariaDBのrootパスワード
# --------------
mariadb_root_password: r00t_P455w0rd

# --------------
# データベース
# --------------
mariadb_databases:
  # 開発用データベース
  - name: app_dev
    password: app_dev_P455w0rd
    hosts:
      - "127.0.0.1"
      - localhost
      - "192.168.%"
      - "10.%"
  # テスト用データベース
  - name: app_test
    # import_data: /vagrant/source/test_data.sql
    password: app_test_P455w0rd
    hosts:
      - "127.0.0.1"
      - localhost
      - "192.168.%"
      - "10.%"
  # ステージング用データベース
  - name: app_staging
    password: app_staging_P455w0rd
    hosts:
      - "127.0.0.1"
      - localhost
      - "192.168.%"
      - "10.%"
  # 本番用データベース
  - name: app_prod
    password: app_prod_P455w0rd
    hosts:
      - "127.0.0.1"
      - localhost
      - "192.168.%"
      - "10.%"

# --------------
# 外部のホストからのMariaDBへの接続を許可
# --------------
mariadb_allow_connect_other_host: true

apache_extra_cfg: |
  EnableSendfile Off

nginx_extra_cfg: |
  sendfile off;

# --------------
# Apacheのバーチャルホストの設定
# --------------
apache_vhosts:
  # ローカルのPCと共有している領域 ( http://www.<ドメイン>/ )
  - name: 000-default
    default: true
    # サーバー名
    server_name: "{{ domain }}"
    # ドキュメントルート
    document_root: /var/www/html{{ doc_root_suffix | default('', true) }}
    # サーバー名の別名
    server_alias: "www.{{ domain }}"
    # AllowOverrideの設定値
    allow_override: All
    options:
      - "-Indexes"
      - "+SymLinksIfOwnerMatch"
    directory_index:
      - index.php
      - index.html
    custom_log:
      path: /var/log/apache2/access.log
      format: combined
    error_log:
      path: /var/log/apache2/error.log
      log_level: warn
  # MailHog用のバーチャルホスト ( http://mailhog.<ドメイン>/ )
  # https://github.com/mailhog/MailHog
  - name: 001-MailHog
    server_name: mailhog.{{ domain }}
    custom_log:
      path: /var/log/apache2/mailhog_access.log
      format: combine
    error_log:
      path: /var/log/apache2/mailhog_error.log
      log_level: warn
    # リバースプロキシの設定
    proxy_pass:
      - from: /
        to: "http://localhost:8025/"
    proxy_pass_reverse:
      - from: /
        to: "http://localhost:8025/"
  - name: 002-phpMyAdmin
    server_name: db.{{ domain }}
    document_root: "{{ phpmyadmin_dest }}"
    allow_override: All
    directory_index:
      - index.php
    custom_log:
      path: /var/log/apache2/phpmyadmin_access.log
      format: combine
    error_log:
      path: /var/log/apache2/phpmyadmin_error.log
      log_level: warn
    extra_setting: |
      <Directory {{ phpmyadmin_dest }}/templates>
          Require all denied
      </Directory>
      <Directory {{ phpmyadmin_dest }}/libraries>
          Require all denied
      </Directory>
      <Directory {{ phpmyadmin_dest }}/setup>
          Require all denied
      </Directory>
      <Directory {{ phpmyadmin_upload_dir }}>
          Require all denied
      </Directory>
      <Directory {{ phpmyadmin_save_dir }}>
          Require all denied
      </Directory>
      <Directory {{ phpmyadmin_tmp_dir }}>
          Require all denied
      </Directory>
  - name: 003-phpRedisAdmin
    server_name: cache.{{ domain }}
    document_root: "{{ phpredisadmin_dest }}"
    allow_override: All
    directory_index:
      - index.php
    custom_log:
      path: /var/log/apache2/phpredisadmin_access.log
      format: combine
    error_log:
      path: /var/log/apache2/phpredisadmin_error.log
      log_level: warn

# --------------
# Nginxのバーチャルホストの設定
# --------------
nginx_vhosts:
  - name: default
    default: true
    server_name:
      - "{{ domain }}"
      - "www.{{ domain }}"
    access_log: /var/log/nginx/access.log
    error_log: /var/log/nginx/error.log
    document_root: /var/www/html{{ doc_root_suffix | default('', true) }}
    index:
      - index.php
      - index.html
    client_max_body_size: 20M
    locations:
      - pattern: "/"
        content:
          try_files $uri $uri/ =404;
      - pattern: "\\.php$"
        match_type: "~"
        content: |
          include snippets/fastcgi-php.conf;
          fastcgi_pass unix:/run/php/php7.4-fpm.sock;
      - pattern: "/\\.ht"
        match_type: "~"
        content: |
          deny all;
  # MailHog用のバーチャルホスト ( http://mailhog.<ドメイン>/ )
  - name: mailhog
    server_name: mailhog.{{ domain }}
    access_log: /var/log/nginx/mailhog_access.log
    error_log: /var/log/nginx/mailhog_error.log
    locations:
      - pattern: /
        content: |
          proxy_pass http://localhost:8025/;
          include proxy_params;
  # phpMyAdmin用のバーチャルホスト ( http://db.<ドメイン>/ )
  - name: phpMyAdmin
    server_name: db.{{ domain }}
    document_root: "{{ phpmyadmin_dest }}"
    index:
      - index.php
      - index.html
    client_max_body_size: 20M
    access_log: /var/log/nginx/phpmyadmin_access.log
    error_log: /var/log/nginx/phpmyadmin_error.log
    locations:
      - pattern: "/"
        content:
          try_files $uri $uri/ =404;
      - pattern: "\\.php$"
        match_type: "~"
        content: |
          include snippets/fastcgi-php.conf;
          fastcgi_pass unix:/run/php/php{{ php_version }}-fpm.sock;
      - pattern: "/\\.ht"
        match_type: "~"
        content: |
          deny all;
      - pattern: "/templates"
        match_type: "^~"
        content: |
          deny all;
      - pattern: "/libraries"
        match_type: "^~"
        content: |
          deny all;
      - pattern: "/setup"
        match_type: "^~"
        content: |
          deny all;
      - pattern: "/{{ phpmyadmin_upload_dir | replace(phpmyadmin_dest, '') }}"
        match_type: "^~"
        content: |
          deny all;
      - pattern: "/{{ phpmyadmin_save_dir | replace(phpmyadmin_dest, '') }}"
        match_type: "^~"
        content: |
          deny all;
      - pattern: "/{{ phpmyadmin_tmp_dir | replace(phpmyadmin_dest, '') }}"
        match_type: "^~"
        content: |
          deny all;
  # phpRedisAdmin用のバーチャルホスト ( http://cache.<ドメイン>/ )
  - name: phpRedisAdmin
    server_name: cache.{{ domain }}
    document_root: "{{ phpredisadmin_dest }}"
    index:
      - index.php
      - index.html
    client_max_body_size: 20M
    access_log: /var/log/nginx/phpredisadmin_access.log
    error_log: /var/log/nginx/phpredisadmin_error.log
    locations:
      - pattern: "/"
        content:
          try_files $uri $uri/ =404;
      - pattern: "\\.php$"
        match_type: "~"
        content: |
          include snippets/fastcgi-php.conf;
          fastcgi_pass unix:/run/php/php{{ php_version }}-fpm.sock;
      - pattern: "/\\.ht"
        match_type: "~"
        content: |
          deny all;
  - name: status
    server_name: localhost
    listen: 8080
    locations:
      - pattern: "/nginx_status"
        content: |
          stub_status on;

# --------------
# MariaDBの設定
# --------------
mariadb_mysqld_cfg:
  sql_mode:
    - STRICT_TRANS_TABLES
    - NO_ZERO_IN_DATE
    - NO_ZERO_DATE
    - ERROR_FOR_DIVISION_BY_ZERO
    - NO_AUTO_CREATE_USER
    - NO_ENGINE_SUBSTITUTION
  slow_query_log: true
  long_query_time: 1
  # log_warnings: 0
  # min_examined_row_limit: 0
  # log_queries_not_using_indexes: false
  # log_slow_admin_statements: false
  slow_query_log_file: /var/log/mariadb/slow_query.log
  general_log: false
  general_log_file: /var/log/mariadb/general.log

dehydrated_cfg:
  CA: https://acme-staging-v02.api.letsencrypt.org/directory

mackerel_agent_active_and_enabled_on_system_startup: false
