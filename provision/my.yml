- name: install python pip
  ansible.builtin.apt:
    name: python3-pip
- name: user setting
  block:
    - name: install pip packages
      ansible.builtin.pip:
        name:
          - ansible
          - mkdocs-material
          - mycli
        extra_args: --user
    - name: create user directory
      ansible.builtin.file:
        path: ~/{{ item }}
        state: directory
        mode: "0755"
      loop:
        - bin
        - .local/share/bash-completion/completions
    - name: check comoser command
      ansible.builtin.shell:
        cmd: type composer
      register: composer_command_result
      failed_when: false
      changed_when: false
    - name: create composer completion file
      ansible.builtin.shell:
        cmd: composer completion >~/.local/share/bash-completion/completions/composer
        creates: ~/.local/share/bash-completion/completions/composer
      when: not composer_command_result.rc
    - name: check npm command
      ansible.builtin.shell:
        cmd: type npm
      register: npm_command_result
      failed_when: false
      changed_when: false
    - name: create npm completion file
      ansible.builtin.shell:
        cmd: npm completion >~/.local/share/bash-completion/completions/npm
        creates: ~/.local/share/bash-completion/completions/npm
      when: not npm_command_result.rc
    - name: check yarn command
      ansible.builtin.shell:
        cmd: type yarn
      register: yarn_command_result
      failed_when: false
      changed_when: false
    - name: create yarn completion file
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/dsifford/yarn-completion/master/yarn-completion.bash
        dest: ~/.local/share/bash-completion/completions/yarn
        mode: "0644"
      when: not yarn_command_result.rc
    - name: create scripts
      ansible.builtin.template:
        src: "{{ item }}"
        dest: ~/bin/{{ item[:-3] | basename }}
        mode: "0700"
      loop: "{{ lookup('fileglob', 'scripts/*.j2', wantlist=True)  }}"
    - name: set tbls enviromnet variables
      ansible.builtin.blockinfile:
        path: ~/.bashrc
        marker: "# {mark} tbls setting ANSIBLE MANAGED BLOCK"
        block: |
          export TBLS_DSN=mariadb://{{ lde_db_user }}:{{ lde_db_password }}@{{ lde_db_host }}:3306/{{ lde_db_name }}
          export TBLS_DOC_PATH=/vagrant/src/docs/schema
    - name: install bash git prompt
      ansible.builtin.git:
        repo: https://github.com/magicmonty/bash-git-prompt.git
        dest: ~/.bash-git-prompt
        version: master
        depth: 1
    - name: append bash git prompt setting on .bashrc
      ansible.builtin.blockinfile:
        path: ~/.bashrc
        marker: "# {mark} bash-git-prompt setting ANSIBLE MANAGED BLOCK"
        block: |
          if [ -f "$HOME/.bash-git-prompt/gitprompt.sh" ]; then
              GIT_PROMPT_ONLY_IN_REPO=1
              source $HOME/.bash-git-prompt/gitprompt.sh
          fi
    - name: set .inputrc
      ansible.builtin.lineinfile:
        path: ~/.inputrc
        regexp: "^set completion-ignore-case"
        line: set completion-ignore-case on
        create: true
    - name: user git setting
      community.general.git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: global
      loop:
        - name: alias.au
          value: add --update
        - name: alias.br
          value: branch
        - name: alias.ca
          value: commit --amend
        - name: alias.ci
          value: commit
        - name: alias.co
          value: checkout
        - name: alias.dc
          value: diff --cached
        - name: alias.st
          value: status -s
        - name: alias.lg
          value: log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %Cblue<%an>%Creset' --abbrev-commit --date=iso --all --decorate
        - name: fetch.prune
          value: "true"
        - name: pull.rebase
          value: "true"
    - name: create mysql connection file
      ansible.builtin.blockinfile:
        path: ~/.my.cnf
        create: true
        mode: "0600"
        block: |
          [client]
          host=localhost
          database={{ lde_db_name }}
          user={{ lde_db_user }}
          password={{ lde_db_password }}
          default_character_set={{ lde_db_encoding }}
      when: mariadb_databases[0] is defined
    - name: create mycli setting file
      ansible.builtin.blockinfile:
        path: ~/.myclirc
        create: true
        mode: "0600"
        block: |
          [main]
          # Enables context sensitive auto-completion. If this is disabled then all
          # possible completions will be listed.
          smart_completion = True
          # Multi-line mode allows breaking up the sql statements into multiple lines. If
          # this is set to True, then the end of the statements must have a semi-colon.
          # If this is set to False then sql statements can't be split into multiple
          # lines. End of line (return) is considered as the end of the statement.
          multi_line = False
          # Enable the pager on startup.
          enable_pager = False
          # Skip intro info on startup and outro info on exit
          less_chatty = True
    - name: install github deploykey
      ansible.builtin.copy:
        src: "{{ github_deploykey_path }}"
        dest: ~/.ssh/github_deploykey
        mode: '0600'
        remote_src: "{{ vagrant_provisioner == 'anslble_local' | ternary(true, false) }}"
      when: github_deploykey_path is defined
    - name: install bitbucket deploykey
      ansible.builtin.copy:
        src: "{{ bitbucket_deploykey_path }}"
        dest: ~/.ssh/bitbucket_deploykey
        mode: '0600'
        remote_src: "{{ vagrant_provisioner == 'anslble_local' | ternary(true, false) }}"
      when: bitbucket_deploykey_path is defined
    - name: install gitlab deploykey
      ansible.builtin.copy:
        src: "{{ gitlab_deploykey_path }}"
        dest: ~/.ssh/gitlab_deploykey
        mode: '0600'
        remote_src: "{{ vagrant_provisioner == 'anslble_local' | ternary(true, false) }}"
      when: gitlab_deploykey_path is defined
    - name: install backlog ssh key
      ansible.builtin.copy:
        src: "{{ backlog_deploykey_path }}"
        dest: ~/.ssh/backlog_deploykey
        mode: '0600'
        remote_src: "{{ vagrant_provisioner == 'anslble_local' | ternary(true, false) }}"
      when: backlog_deploykey_path is defined
    - name: Insert/Update ssh configuration block in ~/.ssh/config
      ansible.builtin.blockinfile:
        path: ~/.ssh/config
        block: |
          {% if github_deploykey_path is defined -%}
          Host github.com
            IdentityFile ~/.ssh/github_deploykey
            StrictHostKeyChecking no
            User git
          {% endif %}
          {% if bitbucket_deploykey_path is defined -%}
          Host bitbucket.org
            IdentityFile ~/.ssh/bitbucket_deploykey
            StrictHostKeyChecking no
            User git
          {% endif %}
          {% if gitlab_deploykey_path is defined -%}
          Host gitlab.com
            IdentityFile ~/.ssh/gitlab_deploykey
            StrictHostKeyChecking no
            User git
          {% endif %}
          {% if backlog_deploykey_path is defined -%}
          Host *.git.backlog.jp
            IdentityFile ~/.ssh/backlog_deploykey
            StrictHostKeyChecking no
          {% endif %}
        create: true
        mode: "0600"
  become: false
