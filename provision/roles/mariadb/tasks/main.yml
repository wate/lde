---
- name: install MariaDB packages
  apt:
    update_cache: true
    name: "{{ mariadb_packages }}"
- name: include package name vars
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - '{{ ansible_facts.os_family }}/{{ ansible_facts.distribution }}/{{ ansible_facts.distribution_major_version }}.yml'
        - '{{ ansible_facts.os_family }}/{{ ansible_facts.distribution }}.yml'
        - '{{ ansible_facts.os_family }}.yml'
      paths:
        - vars
- name: install dependency packages
  apt:
    name: "{{ mariadb_dependency_packages }}"
- name: Ensure includedir setting
  lineinfile:
    path: "{{ mariadb_config_base_dir }}/my.cnf"
    line: "!includedir {{ mariadb_config_dir }}/"
  notify: restart mariadb
- name: create MariaDB setting files
  template:
    src: custom.cnf.j2
    dest: "{{ mariadb_config_dir }}/99-custom.cnf"
    mode: "0644"
  notify: restart mariadb
- name: MariaDB is active and enabled on system startup
  systemd:
    name: mariadb
    state: started
    enabled: true
- name: execute mysql_secure_installation
  import_tasks: secure_installation.yml
  tags: mysql_secure_installation
- name: create / remove databases
  mysql_db:
    name: "{{ item.name }}"
    encoding: "{{ item.encoding | default(mariadb_default_charset) }}"
    collation: "{{ item.collation | default(mariadb_default_collation) }}"
    state: "{{ item.state | default(true) | ternary('present', 'absent') }}"
    login_unix_socket: "{{ mariadb_unix_socket_path }}"
  loop: "{{ mariadb_databases }}"
  loop_control:
    label: "{{ item.name }}"
- name: create MariaDB users(on mariadb_databases variable)
  mysql_user:
    name: "{{ item.0.user | default(item.0.name) }}"
    password: "{{ item.0.password | default(omit) }}"
    host: "{{ item.1 }}"
    priv: "{{ item.0.name }}.*:ALL"
    login_unix_socket: "{{ mariadb_unix_socket_path }}"
  loop: "{{ lookup('subelements', mariadb_databases, 'hosts', {'skip_missing': True}) }}"
  no_log: true
- name: create / remove MariaDB users
  mysql_user:
    name: "{{ item.0.name }}"
    password: "{{ item.0.password }}"
    host: "{{ item.1 }}"
    priv: "{{ item.0.privs | join('/') }}"
    state: "{{ item.0.state | default(true) | ternary('present', 'absent') }}"
    login_unix_socket: "{{ mariadb_unix_socket_path }}"
  loop: "{{ lookup('subelements', mariadb_users, 'hosts') }}"
  no_log: true
- name: allow MariaDB port
  ufw:
    rule: allow
    port: "3306"
    proto: tcp
  when: mariadb_allow_connect_other_host | default(false)
