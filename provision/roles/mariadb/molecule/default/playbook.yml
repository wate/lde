---
- name: Converge
  hosts: all
  gather_facts: true
  become: true
  vars:
    mariadb_databases:
      - name: app_dev
        password: app_dev_p455w0rd
        hosts:
          - "127.0.0.1"
          - "::1"
          - localhost
      - name: app_staging
        user: staging
        password: staging_p455w0rd
        hosts:
          - "127.0.0.1"
          - "::1"
          - localhost
      - name: app_test
      - name: app_prod
    mariadb_users:
      - name: mackerel_agent
        password: m4ckerel_4gent_p455w0rd
        hosts:
          - "127.0.0.1"
          - "::1"
          - localhost
        privs:
          - "*.*:PROCESS,REPLICATION CLIENT"
      - name: app_test
        password: app_test_p455w0rd
        hosts:
          - "127.0.0.1"
          - "::1"
          - localhost
        privs:
          - "*.*:All"
      - name: app_prod
        password: app_prod_p455w0rd
        hosts:
          - "127.0.0.1"
          - "::1"
          - localhost
        privs:
          - "*.*:All"
  roles:
    - role: mariadb
  pre_tasks:
    - name: dump vars
      block:
        - name: create dump directory
          file:
            path: dump_vars
            state: directory
          changed_when: false
        - name: dump vars
          blockinfile:
            path: "dump_vars/{{ inventory_hostname }}.yml"
            create: true
            block: "{{ vars | to_json }}"
          changed_when: false
      connection: local
      become: false
