- name: manage groups
  group:
    name: "{{ item.name }}"
    gid: "{{ item.id | default(omit) }}"
    system: "{{ item.system | default(omit) }}"
    state: "{{ 'absent' if item.removed | default(false) else 'present' }}"
  with_items: "{{ common_groups }}"
  loop_control:
    label: "{{ item.name }}"
- name: manage users
  user:
    name: "{{ item.name }}"
    password: "{{ item.password | default(omit) }}"
    shell: "{{ item.shell | default('/usr/bin/bash') }}"
    groups: "{{ item.groups | default(omit) }}"
    uid: "{{ item.id | default(omit) }}"
    system: "{{ item.system | default(omit) }}"
    home: "{{ item.home | default(omit) }}"
    state: "{{ 'absent' if item.removed | default(false) else 'present' }}"
    # `userdel` command `--remove` option
    remove: "{{ item.removed | default(false) }}"
  with_items: "{{ common_users }}"
  loop_control:
    label: "{{ item.name }}"
- name: set authorized keys
  authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1.key }}"
    state: "{{ 'absent' if item.1.removed | default(false) else 'present' }}"
  with_subelements:
    - "{{ common_users | selectattr('removed', 'undefined') | selectattr('authorized_keys', 'defined') | list }}"
    - authorized_keys
  loop_control:
    label: "{{ item.0.name }} : {{ item.1 }}"
- name: manage secret variable
  lineinfile:
    path: ~/.secret
    regexp: "^export {{ item.1.name }}=.*"
    line: 'export {{ item.1.name }}="{{ item.1.value | default("") }}"'
    create: true
    mode: "0600"
    state: "{{ 'absent' if item.1.removed | default(false) else 'present' }}"
  become_user: "{{ item.0.name }}"
  become: true
  with_subelements:
    - "{{ common_users | selectattr('removed', 'undefined') | selectattr('secret_vars', 'defined') | list }}"
    - secret_vars
  loop_control:
    label: "{{ item.0.name }} : {{ item.1.name }}"
  tags: secret
- name: add admin group for admin users
  user:
    name: "{{ item.name }}"
    groups: wheel
    append: true
  with_items: "{{ common_users | selectattr('removed', 'undefined') | selectattr('admin', 'defined') | selectattr('admin', 'equalto', true) | list }}"
  loop_control:
    label: "{{ item.name }}"
- name:  Manage cron job variavle
  cronvar:
    user: "{{ item.0.name }}"
    name: "{{ item.1.name }}"
    value: "{{ omit if item.1.removed | default(false) else item.1.value | default('') }}"
    state: "{{ 'absent' if item.1.removed | default(false) else 'present' }}"
  with_subelements:
    - "{{ common_users | selectattr('removed', 'undefined') | selectattr('cron_vars', 'defined') | list }}"
    - cron_vars
  loop_control:
    label: "{{ item.0.name }} : {{ item.1.name }}"
- name: Manage cron jobs
  cron:
    user: "{{ item.0.name }}"
    name: "{{ item.1.name }}"
    job: "{{ item.1.job }}"
    month: "{{ item.1.month | default('*') | string }}"
    day: "{{ item.1.day | default('*') | string }}"
    hour: "{{ item.1.hour | default('*') | string }}"
    minute: "{{ item.1.minute | default('*') | string }}"
    weekday: "{{ item.1.weekday | default('*') | string }}"
    disabled: "{{ true if item.1.disable | default(false) else false }}"
    state: "{{ 'absent' if item.1.removed | default(false) else 'present' }}"
  with_subelements:
    - "{{ common_users | selectattr('removed', 'undefined') | selectattr('cron_jobs', 'defined') | list }}"
    - cron_jobs
  loop_control:
    label: "{{ item.0.name }} : {{ item.1.name }}"
- name: set root lock status
  command: passwd -{{'l' if common_root_lock else 'u' }} root
  when: common_root_lock is defined
  tags:
    - skip_ansible_lint
