---
- name: install xhprof module
  ansible.builtin.apt:
    name:
      - php-xhprof
      - graphviz
- name: checkout XHProf UI source
  ansible.builtin.git:
    repo: https://github.com/preinheimer/xhprof.git
    dest: "{{ php_xhprof_dest }}"
    version: master
- name: check exists xhprof ui config file
  ansible.builtin.stat:
    path: "{{ php_xhprof_dest }}/xhprof_lib/config.php"
  register: stat_result
- name: copy xhprof config file
  ansible.builtin.copy:
    src: "{{ php_xhprof_dest }}/xhprof_lib/config.sample.php"
    dest: "{{ php_xhprof_dest }}/xhprof_lib/config.php"
    mode: "0644"
    remote_src: true
  when: not stat_result.stat.exists
- name: set xhprof ui config
  ansible.builtin.blockinfile:
    path: "{{ php_xhprof_dest }}/xhprof_lib/config.php"
    content: "{{ php_xhprof_ui_cfg }}"
- name: check config directory(cli)
  ansible.builtin.stat:
    path: "{{ php_cli_conf_dir }}"
  register: stat_php_cli_dir_result
- name: add xhprof php config(cli)
  ansible.builtin.template:
    src: xhprof.ini.j2
    dest: "{{ php_cli_conf_dir }}/95-xhprof.ini"
    mode: "0644"
  vars:
    php_xhprof_set_auto_prepend_file: "{{ php_xhprof_cli_set_auto_prepend_file }}"
  when: stat_php_cli_dir_result.stat.exists
- name: check config directory(fpm)
  ansible.builtin.stat:
    path: "{{ php_fpm_conf_dir }}"
  register: stat_php_fpm_dir_result
- name: add xhprof php config(fpm)
  ansible.builtin.template:
    src: xhprof.ini.j2
    dest: "{{ php_fpm_conf_dir }}/95-xhprof.ini"
    mode: "0644"
  vars:
    php_xhprof_set_auto_prepend_file: "{{ php_xhprof_fpm_set_auto_prepend_file }}"
  notify: restart php-fpm
  when: stat_php_fpm_dir_result.stat.exists
- name: check config directory(apache)
  ansible.builtin.stat:
    path: "{{ php_apache_conf_dir }}"
  register: stat_php_apache_dir_result
- name: add xhprof php config(apache)
  ansible.builtin.template:
    src: xhprof.ini.j2
    dest: "{{ php_apache_conf_dir }}/95-xhprof.ini"
    mode: "0644"
  vars:
    php_xhprof_set_auto_prepend_file: "{{ php_xhprof_apache_set_auto_prepend_file }}"
  when: stat_php_apache_dir_result.stat.exists
- name: create XHProf storage database
  community.mysql.mysql_db:
    name: "{{ php_xhprof_database_name }}"
    encoding: utf8mb4
    collation: utf8mb4_general_ci
    login_unix_socket: /run/mysqld/mysqld.sock
- name: create XHProf storage database user
  community.mysql.mysql_user:
    name: "{{ php_xhprof_database_user }}"
    password: "{{ php_xhprof_database_password }}"
    host: "{{ item }}"
    priv: "{{ php_xhprof_database_name }}.*:ALL"
    login_unix_socket: /run/mysqld/mysqld.sock
  loop:
    - "127.0.0.1"
    - localhost
  no_log: true
- name: copy DB schema file
  ansible.builtin.copy:
    src: ddl.sql
    dest: "{{ php_xhprof_dest }}/xhprof_lib/ddl.sql"
    mode: "0644"
- name: import the DB schema
  community.mysql.mysql_db:
    name: "{{ php_xhprof_database_name }}"
    login_user: "{{ php_xhprof_database_user }}"
    login_password: "{{ php_xhprof_database_password }}"
    target: "{{ php_xhprof_dest }}/xhprof_lib/ddl.sql"
    state: import
