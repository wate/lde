- name: set wp-cli config vars
  set_fact:
    wp_cli_cfg:
      core download:
        locale: "{{ wordpress.download_locale|default('en_US') }}"
      config create:
        dbname: "{{ mariadb_databases[0].name }}"
        dbuser: "{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}"
        dbpass: "{{ mariadb_databases[0].password }}"
        dbcharset: "{{ mariadb_databases[0].encoding|default(mariadb_default_charset) }}"
        dbcollate: "{{ mariadb_databases[0].collation|default(mariadb_default_collation) }}"
        extra-php: "{{ wordpress.extra_config|default('') }}"
      core install:
          url: "{{ apache_vhosts[0].server_name }}"
          title: "{{ wordpress.title }}"
          admin_user: "{{ wordpress.admin_user }}"
          admin_password: "{{ wordpress.admin_password }}"
          admin_email: "{{ wordpress.admin_email }}"
- name: create wp-cli config file
  blockinfile:
    path: /tmp/wp-cli.yml
    block: "{{ wp_cli_cfg|to_nice_yaml }}"
    create: yes
- block:
    - name: download WordPress
      command: /usr/local/bin/wp core download
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
        creates: "{{ apache_vhosts[0].document_root }}/wp-config-sample.php"
    - name: create WordPress config file
      command: /usr/local/bin/wp config create
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
        creates: "{{ apache_vhosts[0].document_root }}/wp-config.php"
    - name: check WordPress installed
      command: /usr/local/bin/wp core is-installed
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
      ignore_errors: yes
      changed_when: no
      register: result
    - name: install WordPress
      command: /usr/local/bin/wp core install
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
      when: result.rc > 0
    - name: activate WP Multibyte Patch plugin
      command: /usr/local/bin/wp plugin activate wp-multibyte-patch
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
      when: wp_cli_cfg['core download'].locale is defined and wp_cli_cfg['core download'].locale == 'ja'
    - name: install WordPress plugins
      command: /usr/local/bin/wp plugin install {{ item }} --activate
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
        creates: "{{ apache_vhosts[0].document_root }}//wp-content/plugins/{{ item }}"
      with_items: "{{ wordpress.plugins }}"
    - name: install WordPress themes
      command: /usr/local/bin/wp theme install {{ item }}
      args:
        chdir: "{{ apache_vhosts[0].document_root }}"
        creates: "{{ apache_vhosts[0].document_root }}//wp-content/themes/{{ item }}"
      with_items: "{{ wordpress.themes }}"
  become: no
  environment:
    WP_CLI_CONFIG_PATH: /tmp/wp-cli.yml
