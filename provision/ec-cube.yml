- name: install php APCu module
  yum:
    name: php-pecl-apcu
- name: create EC-CUBE output directory
  file:
    path: "{{ item }}"
    state: directory
    mode: "0777"
    owner: vagrant
    group: vagrant
  with_items:
    - /var/ec-cube
    - /var/ec-cube/log
    - /var/ec-cube/sessions
- name: check composer.json
  stat:
    path: /var/www/html/composer.json
  register: result
  tags: always
- block:
    - name: remove .gitkeep
      file:
        path: /var/www/html/.gitkeep
        state: absent
    - name: create EC-CUBE project
      composer:
        command: create-project
        arguments: "ec-cube/ec-cube ./"
        prefer_dist: true
        no_dev: true
        no_scripts: true
        working_dir: /var/www/html
    - name: find replace setting files
      find:
        paths: /var/www/html/app/config/eccube/packages
        recurse: true
        patterns: monolog.yml
      register: monolog_result
    - name: replace log directory setting
      replace:
        path: "{{ item }}"
        regexp: "%kernel.logs_dir%"
        replace: /var/ec-cube/log
      with_items: "{{ monolog_result.files | map(attribute='path') | list }}"
    - name: replace session save directory setting
      replace:
        path: /var/www/html/app/config/eccube/packages/framework.yaml
        regexp: "%kernel.project_dir%/var/sessions"
        replace: /var/ec-cube/sessions
    - name: create cache directory symlink
      file:
        path: /var/www/html/var/{{ item }}
        src: /var/ec-cube/{{ item }}
        state: link
      with_items:
        - log
        - sessions
    - name: execute compile
      composer:
        command: run
        arguments: compile
        working_dir: /vagrant/source
    - name: execute auto-scripts
      composer:
        command: run
        arguments: auto-scripts
        working_dir: /vagrant/source
    - name: recreate .gitkeep
      file:
        path: /var/www/html/.gitkeep
        state: touch
        access_time: preserve
        modification_time_format: preserve
    - name: create .env file
      blockinfile:
        path: /var/www/html/.env
        block: |
          APP_ENV={{ ec_cube.app_env }}
          APP_DEBUG={{ '1' if ec_cube.app_debug else '0' }}
          DATABASE_URL=mysql://{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}:{{ mariadb_databases[0].password }}@localhost/{{ mariadb_databases[0].name }}
        create: true
  environment:
    ECCUBE_ADMIN_USER: "{{ ec_cube.admin_user }}"
    ECCUBE_ADMIN_PASS: "{{ ec_cube.admin_pass }}"
    ECCUBE_ADMIN_MAIL: "{{ ec_cube.admin_mail }}"
    ECCUBE_SHOP_NAME: "{{ ec_cube.shop_name }}"
    DATABASE_URL: "mysql://{{ mariadb_databases[0].user|default(mariadb_databases[0].name) }}:{{ mariadb_databases[0].password }}@localhost/{{ mariadb_databases[0].name }}"
  become: false
  when: not result.stat.exists
